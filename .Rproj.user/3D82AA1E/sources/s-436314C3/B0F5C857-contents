---
title: "Assessing the impact of COVID-19 pandemic on emergency diabetes care"
author: "Alexander Lawless"
date: "29th June 2021"
output: 
  html_document:
    theme: cerulean
    toc: TRUE
    toc_float: TRUE
    toc_collapsed: TRUE
    toc_depth: 4
    number_sections: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 9, fig.height = 6)

library(tidyverse)
library(odbc)
library(DBI)
library(lubridate)
library(ggrepel)
library(janitor)
library(knitr)
library(PropCIs)
library(patchwork)
library(kableExtra)

inline_hook <- function(x) {
 
  if(is.numeric(x)) {
    formatted <- format(x, digits = 2)
    
  } else {
    formatted <- x
  }
  
   paste0("**", formatted, "**")
  
}

knit_hooks$set(inline = inline_hook)

## Set SU theme ####
My_rgb2hex <- function(r,g,b) sprintf('#%s',paste(as.hexmode(c(r,g,b)),collapse = ''))

# scale_colour_manual(values = c("#f9bf07", "#686f73", "#5881c1", "#ec6555"))
# scale_colour_manual(values = c("#686f73", "#5881c1", "#ec6555"))

SU_colours <- c (
  `orange` = My_rgb2hex(248,191,7),# "#f9bf07",
  `charcoal` = My_rgb2hex(44,40,37),# "#2c2825",
  `slate` = My_rgb2hex(104,111,115), # "#686f73",
  `blue` = My_rgb2hex(88,29,193), # "#5881c1",
  `red` = My_rgb2hex(236,101,85), # "#ec6555",
  #additional accent colours from word doc template
  `yellow` = My_rgb2hex(252,229,155),
  `grey` = My_rgb2hex(163,168,172),
  `white` = My_rgb2hex(255,255,255),
  #light and dark ends from colour theme in word doc
  `light orange` = My_rgb2hex(253,242,205),
  `dark orange` = My_rgb2hex(124,95,3),
  `light charcoal` = My_rgb2hex(235,233,231),
  `dark charcoal` = 	"#000000",#black
  `light slate` = My_rgb2hex(224,226,227),
  `dark slate` = My_rgb2hex(51,55,57),
  `light blue` = My_rgb2hex(221,229,242),
  `dark blue` = My_rgb2hex(38,61,102),
  `light red` = My_rgb2hex(251,224,220),
  `dark red` = My_rgb2hex(144,29,16),
  `light yellow` = My_rgb2hex(254,249,235),
  `dark yellow` = My_rgb2hex(197,152,5),
  `light grey`=My_rgb2hex(236,237,238),
  `dark grey` = My_rgb2hex(79,84,88),
  `light white`=My_rgb2hex(242,242,242),
  `dark white` =My_rgb2hex(127,127,127),
  `red2` = My_rgb2hex(215,25,28),
  `orange2` = My_rgb2hex(253,174,97),
  `yellow2` = My_rgb2hex(255,255,191),
  `green2` = My_rgb2hex(171,221,164),
  `blue2` = My_rgb2hex(43,131,186)
)



SU_cols <- function(...) {
  cols <- c(...)
  
  if (is.null(cols))
    return (SU_colours)
  
  SU_colours[cols]
}

SU_palettes <- list(
  `main` = SU_cols("orange","charcoal","slate","blue","red"),
  `oranges` = SU_cols("light orange","orange","dark orange"),
  `slates` = SU_cols("light slate","slate","dark slate"),
  `mixed` = SU_cols("dark red","orange","yellow","light blue","slate"),
  `oj_coal` = SU_cols("yellow","orange","red","dark red","dark charcoal"),
  `oj_red` = SU_cols("yellow","orange","red","dark red"),
  `white_oj_coal` = SU_cols("white","yellow","orange","red","dark red","dark charcoal"),#added since shared
  `lyellow_oj_coal` = SU_cols("light yellow","orange","red","dark red","dark charcoal"),#added since shared
  `wy_oj_coal` = SU_cols("white","light yellow","yellow","orange","red","dark red","charcoal","dark charcoal"),
  `red_coal` = SU_cols("red","dark red","charcoal","dark charcoal"),
  `blue_yellow_red` = SU_cols("red2","orange2","yellow2","green2","blue2"),
  `red_yellow_blue` = SU_cols("blue2","green2","yellow2","orange2","red2")
)

SU_pal <- function(palette = "main", reverse = FALSE, ...) {
  pal <- SU_palettes[[palette]]
  
  if (reverse) pal <- rev(pal)
  
  colorRampPalette(pal, ...)
}   

scale_color_SU <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- SU_pal(palette = palette, reverse = reverse)
  
  if (discrete) {
    discrete_scale("colour", paste0("SU_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}


scale_fill_SU <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- SU_pal(palette = palette, reverse = reverse)
  
  if (discrete) {
    discrete_scale("fill", paste0("SU_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}  

##Theme


##set theme settings
theme_SU<-
  function (base_size){
    theme_minimal(
      #base_family = "Segoe UI", 
      base_size=12
    ) %+replace% 
      theme(axis.title = element_text(size=11, face="bold",colour=SU_cols("charcoal")),
            plot.title = element_text(hjust=0,face="bold",size=12,colour=SU_cols("charcoal"),margin=margin(b=4,unit="pt")),
            plot.subtitle = element_text(hjust=0,face="italic",size=10,colour=SU_cols("charcoal"),margin=margin(b=4,unit="pt")),
            plot.caption = element_text(hjust = 0,face="italic",size=10,colour=SU_cols("slate"),margin=margin(b=4,unit="pt")),
            legend.text = element_text(size=10,colour=SU_cols("charcoal")),
            legend.title = element_text(face="bold",size=11,colour=SU_cols("charcoal"),margin=margin(b=4,unit="pt")))
  }



##set theme by 
theme_set(theme_SU())

## A. Import SUS data ####

# Connection
a.con <- dbConnect(odbc(), 
                   Driver = "SQL Server", 
                   server = "PRODNHSESQL101", 
                   Database = "NHSE_Sandbox_Spec_Neurology")

a_lsoa_to_stp <- "https://opendata.arcgis.com/datasets/d30531b5888a4e34be4746399d696409_0.csv" %>%
  read_csv() %>% 
  clean_names()

a_stp_to_nhsr <- "https://opendata.arcgis.com/datasets/888dc5cc66ba4ad9b4d935871dcce251_0.csv" %>%
  read_csv() %>% 
  clean_names()

a.ed_diabetes <-
  as_tibble(
    dbGetQuery(a.con, '
select *
from [NHSE_Sandbox_Spec_Neurology].[DBO].[HF_covid_diabetes_activity_ED]'))

a.ip_diabetes <-
  as_tibble(
    dbGetQuery(a.con, '
select *
from [NHSE_Sandbox_Spec_Neurology].[DBO].[HF_covid_diabetes_activity]')) %>% 
  mutate(Age_range = case_when(Der_Age_At_CDS_Activity_Date >= 0 & Der_Age_At_CDS_Activity_Date < 20 ~ "0-19",
                               (Der_Age_At_CDS_Activity_Date >= 20 & Der_Age_At_CDS_Activity_Date <40) ~  "20-39",
                               (Der_Age_At_CDS_Activity_Date >= 40 & Der_Age_At_CDS_Activity_Date <60) ~  "40-59",
                               (Der_Age_At_CDS_Activity_Date >= 60 & Der_Age_At_CDS_Activity_Date <80) ~  "60-79",
                               (Der_Age_At_CDS_Activity_Date >= 80 & Der_Age_At_CDS_Activity_Date <100) ~ "80-99",
                               Der_Age_At_CDS_Activity_Date >= 100 ~ "100+")) %>% 
  mutate(Age_range = factor(Age_range, levels = c("0-19", 
                                                  "20-39",
                                                  "40-59",
                                                  "60-79",
                                                  "80-99", 
                                                  "100+"))) %>% 
  left_join(a_lsoa_to_stp, by = c("Der_Postcode_LSOA_2011_Code" = "lsoa11cd")) %>% 
  left_join(a_stp_to_nhsr %>% 
              select(stp20cd, nhser20cd, nhser20nm) %>% 
              distinct(), 
            by = c("stp20cd"))

a.diabetes_ip_icd10 <- c('E10', 'E11', 'E12', 'E13', 'E14')

a.diabetes_ip_planned_index <-
  as_tibble(
    dbGetQuery(a.con, '
select *
from [NHSE_Sandbox_Spec_Neurology].[DBO].[HF_covid_diabetes_activity_planned_index]')) %>% 
  mutate(Age_range = case_when(Der_Age_At_CDS_Activity_Date >= 0 & Der_Age_At_CDS_Activity_Date < 20 ~ "0-19",
                               (Der_Age_At_CDS_Activity_Date >= 20 & Der_Age_At_CDS_Activity_Date <40) ~  "20-39",
                               (Der_Age_At_CDS_Activity_Date >= 40 & Der_Age_At_CDS_Activity_Date <60) ~  "40-59",
                               (Der_Age_At_CDS_Activity_Date >= 60 & Der_Age_At_CDS_Activity_Date <80) ~  "60-79",
                               (Der_Age_At_CDS_Activity_Date >= 80 & Der_Age_At_CDS_Activity_Date <100) ~ "80-99",
                               Der_Age_At_CDS_Activity_Date >= 100 ~ "100+")) %>% 
  mutate(Age_range = factor(Age_range, levels = c("0-19", 
                                                  "20-39",
                                                  "40-59",
                                                  "60-79",
                                                  "80-99", 
                                                  "100+"))) %>% 
  left_join(a_lsoa_to_stp, by = c("Der_Postcode_LSOA_2011_Code" = "lsoa11cd")) %>% 
  left_join(a_stp_to_nhsr %>% 
              select(stp20cd, nhser20cd, nhser20nm) %>% 
              distinct(), 
            by = c("stp20cd"))


a.diabetes_ip_unplanned_index <-
  as_tibble(
    dbGetQuery(a.con, '
select *
from [NHSE_Sandbox_Spec_Neurology].[DBO].[HF_covid_diabetes_activity_unplanned_index]')) %>% 
  mutate(Age_range = case_when(Der_Age_At_CDS_Activity_Date >= 0 & Der_Age_At_CDS_Activity_Date < 20 ~ "0-19",
                               (Der_Age_At_CDS_Activity_Date >= 20 & Der_Age_At_CDS_Activity_Date <40) ~  "20-39",
                               (Der_Age_At_CDS_Activity_Date >= 40 & Der_Age_At_CDS_Activity_Date <60) ~  "40-59",
                               (Der_Age_At_CDS_Activity_Date >= 60 & Der_Age_At_CDS_Activity_Date <80) ~  "60-79",
                               (Der_Age_At_CDS_Activity_Date >= 80 & Der_Age_At_CDS_Activity_Date <100) ~ "80-99",
                               Der_Age_At_CDS_Activity_Date >= 100 ~ "100+")) %>% 
  mutate(Age_range = factor(Age_range, levels = c("0-19", 
                                                  "20-39",
                                                  "40-59",
                                                  "60-79",
                                                  "80-99", 
                                                  "100+"))) %>% 
  left_join(a_lsoa_to_stp, by = c("Der_Postcode_LSOA_2011_Code" = "lsoa11cd")) %>% 
  left_join(a_stp_to_nhsr %>% 
              select(stp20cd, nhser20cd, nhser20nm) %>% 
              distinct(), 
            by = c("stp20cd"))


# Disconnect! # 
dbDisconnect(a.con) 

# Lockdown dates
a_reference_dates <-
  tribble(
    ~Reference_date, ~Desc, ~Start_flag,
    
    "2020-03-23",	"National lockdown", "Y",  	
    "2020-07-04",	"National lockdown", "N",
    "2020-10-14", "3 Tier lockdown", "Y",
    "2021-01-04", "3 Tier lockdown", "N",
    "2020-05-13", "National lockdown label", "N",
    "2020-11-24", "3 Tier lockdown label", "N",
    "2020-08-24", "Recovery periond label", "N"
  ) %>% 
  mutate(Reference_date = as.Date(Reference_date)) %>% 
  mutate(date_numeric = as.numeric(Reference_date)) %>% 
  mutate(week_number = isoweek(Reference_date))


## B. High level summary ####
# Diabetes ED attendances - daily
b_diabetes_ed_daily <-
  a.ed_diabetes %>% 
  group_by(substr(Arrival_Date, 1, 10)) %>% 
  summarise(n_attendances = n_distinct(EC_Ident)) %>%  #sum monthly attendances
  rename(Date = 1)

# Diabetes ED attendances - daily 
b_diabetes_ed_daily_vis <-
  b_diabetes_ed_daily %>% 
  filter(Date > "2018-01-01" & 
           Date < "2020-12-31") %>%
  mutate(week_day = weekdays(as.Date(Date))) %>%
  mutate(weekend_flag = case_when(substr(week_day,1,1) == "S" ~ "Weekend",
                                  TRUE ~ "Week day")) %>% 
  
  ggplot(aes(x = as.Date(Date), y = n_attendances)) +
  annotate("rect", xmin = as.Date("2020-03-23"), xmax = as.Date("2020-07-04"), ymin = 0, ymax = Inf, 
           fill= "#fed976", alpha = 0.8) + # Lockdown 1
  annotate("rect", xmin = as.Date("2020-10-14"), xmax = as.Date("2021-01-04"), ymin = 0, ymax = Inf, 
           fill= "#fed976", alpha = 0.8) + # 3 tier system
  annotate("text", x = as.Date("2020-05-13"), y = 100, label = "National lockdown",size = 5, angle = 90) +
  annotate("text", x = as.Date("2020-11-24"), y = 100, label = "3 Tier lockdown",size = 5, angle = 90) +
  #geom_point(aes(colour = weekend_flag), size = 1, alpha = 0.5) +
  geom_smooth(method = "loess", span = 0.15) +
  labs(title = "Emergency attendances for diabetes were temporarily disrupted by covid-19 but recovered quickly",
       subtitle = "Emergency activity: Diabetes related attendances: National",
       x = "Date",
       y = "Attendances")

## C.2. Deprivation #### 
con_ref <- dbConnect(odbc(), 
                     Driver = "SQL Server", 
                     server = "PRODNHSESQL101", 
                     Database = "NHSE_Reference")

c_lsoa_imd <- tbl(con_ref, "tbl_Ref_Other_Deprivation_By_LSOA") %>% 
  collect()

# Disconnect! # 
dbDisconnect(con_ref) 

## C.3. Ethnicity ####
c_ethnicity_lookup <-
  tribble(
    ~Ethnic_Category, ~Ethnic_Category_Desc, ~Ethnicity_broad,
    
    "99",	"Not known", "Not known",	
    "A",	"British", "White",
    "B",	"Irish"	, "White",
    "C",	"Any other white background", "White",
    "D",	"White and black caribbean",	"Mixed",
    "E",	"White and black african",	"Mixed",
    "F",	"White and asian",	"Mixed",
    "G",	"Any other mixed background", "Mixed",
    "H",	"Indian", "Asian",
    "J",	"Pakistani",	"Asian",
    "K",	"Bangladeshi",	"Asian",
    "L",	"Any other asian background", "Asian",
    "M",	"Caribbean",	"Black",
    "N",	"African", "Black",
    "P",	"Any other black background", "Black",
    "R",	"Chinese", "Asian",
    "S",	"Any other ethnic group", "Other",
    "Z",	"Not stated", "Not known",
    "NA", "Not known", "Not known"
  )

## G. Diabetes attendances - Index ####
g_diabetes_snomed <-
  tribble(
    ~ID, ~Description, ~Chapter, ~diabetes_type,
    
    237620003,'Abnormal metabolic state due to diabetes mellitus','Abnormal metabolic state due to diabetes mellitus','Not stated',
    237621004,'Severe hyperglycemia due to diabetes mellitus','Hyperglycemia','Not stated',
    398140007,'Somogyi phenomenon','Hyperglycemia','Not stated',
    822995009,'Hyperglycemia due to diabetes mellitus','Hyperglycemia','Not stated',
    367991000119101,'Hyperglycemia due to type 1 diabetes mellitus','Hyperglycemia','Type 1',
    368051000119109,'Hyperglycemia due to type 2 diabetes mellitus','Hyperglycemia','Type 2',
    441656006,'Hyperglycemic crisis due to diabetes mellitus','Hyperglycemia','Not stated',
    395204000,'Hyperosmolar non-ketotic state due to type 2 diabetes mellitus','Hyperglycemia','Type 2',
    735539005,'Metabolic acidosis due to diabetes mellitus','Diabetic ketoacidosis','Not stated',
    420422005,'Diabetic ketoacidosis','Diabetic ketoacidosis','Not stated',
    721283000,'Acidosis due to type 1 diabetes mellitus','Diabetic ketoacidosis','Type 1',
    721284006,'Acidosis due to type 2 diabetes mellitus','Diabetic ketoacidosis','Type 2',
    735538002,'Lactic acidosis due to diabetes mellitus','Diabetic ketoacidosis','Not stated',
    111556005,'Diabetic ketoacidosis without coma','Diabetic ketoacidosis','Not stated',
    26298008, 'Ketoacidotic coma due to diabetes mellitus','Diabetic ketoacidosis','Not stated',
    190406000,'Malnutrition-related diabetes mellitus with ketoacidosis','Diabetic ketoacidosis','Not stated',
    420270002,'Ketoacidosis due to type 1 diabetes mellitus','Diabetic ketoacidosis','Type 1',
    421750000,'Ketoacidosis due to type 2 diabetes mellitus','Diabetic ketoacidosis','Type 2',
    421075007,'Ketoacidotic coma due to type 1 diabetes mellitus','Diabetic ketoacidosis','Type 1',
    421847006,'Ketoacidotic coma due to type 2 diabetes mellitus','Diabetic ketoacidosis','Type 2',
    1571000119104,'Mixed hyperlipidemia due to type 1 diabetes mellitus','Hyperlidemia','Type 1',
    701000119103,'Mixed hyperlipidemia due to type 2 diabetes mellitus','Hyperlidemia','Type 2',
    137941000119106,'Hyperlipidemia due to type 1 diabetes mellitus','Hyperlidemia','Type 1',
    137931000119102,'Hyperlipidemia due to type 2 diabetes mellitus','Hyperlidemia','Type 2',
    367261000119100,'Hyperosmolarity due to drug induced diabetes mellitus','Hyperosmolarity','Not stated',
    422126006,'Hyperosmolar coma due to diabetes mellitus','Hyperosmolarity','Not stated',
    368561000119102,'Hyperosmolarity due to type 1 diabetes mellitus','Hyperosmolarity','Type 1',
    428896009,'Hyperosmolality due to uncontrolled type 1 diabetes mellitus','Hyperosmolarity','Type 1',
    190330002,'Hyperosmolar coma due to type 1 diabetes mellitus','Hyperosmolarity','Type 1',
    190331003,'Hyperosmolar coma due to type 2 diabetes mellitus','Hyperosmolarity','Type 2',
    368601000119102,'Hyperosmolar coma due to secondary diabetes mellitus','Hyperosmolarity','Not stated',
    735537007,'Hyperosmolar hyperglycemic coma due to diabetes mellitus without ketoacidosis','Hyperosmolarity','Not stated',
    368551000119104,'Dyslipidemia due to type 1 diabetes mellitus','Dyslipidemia','Type 1',
    761000119102,'Dyslipidemia due to type 2 diabetes mellitus','Dyslipidemia','Type 2',
    111231000119109,'Dyslipidemia with high density lipoprotein below reference range and triglyceride above reference range due to type 2 diabetes mellitus','Dyslipidemia','Type 2',
    420662003,'Coma due to diabetes mellitus','Coma','Not stated',
    421966007,'Non-ketotic non-hyperosmolar coma due to diabetes mellitus','Coma','Not stated',
    762489000,'Acute complication due to diabetes mellitus','General','Not stated',
    193183000,'Acute painful diabetic neuropathy','General','Not stated',
    302866003,'Hypoglycemia','Hypoglycemia','Not stated',
    237630007,'Hypoglycemic disorder','Hypoglycemia','Not stated',
    237635002,'Nocturnal hypoglycemia due to diabetes mellitus','Hypoglycemia','Not stated',
    360546002,'Hypoglycemic shock','Hypoglycemia','Not stated',
    66095000,'Mixed hypoglycemia','Hypoglycemia','Not stated',
    20825002,'Ketotic hypoglycemia','Hypoglycemia','Not stated',
    68581004,'Hypoglycemia of childhood','Hypoglycemia','Not stated',
    237631006,'Neuroglycopenia','Hypoglycemia','Not stated',
    237633009,'Hypoglycemia due to diabetes mellitus','Hypoglycemia','Type 1',
    237632004,'Hypoglycemic event due to diabetes','Hypoglycemia','Not stated',
    84371000119108,'Hypoglycemia due to type 1 diabetes mellitus','Hypoglycemia','Type 1',
    421437000,'Hypoglycemic coma due to type 1 diabetes mellitus','Hypoglycemia','Type 1',
    120711000119108,'Hypoglycemic unawareness due to type 1 diabetes mellitus','Hypoglycemia','Type 1',
    421725003,'Hypoglycemic coma due to diabetes mellitus','Hypoglycemia','Not stated',
    719216001,'Hypoglycemic coma due to type 2 diabetes mellitus','Hypoglycemia','Type 2',
    170766006,'Loss of hypoglycemic warning due to diabetes mellitus','Hypoglycemia','Not stated',
    119831000119106,'Hypoglycemia unawareness due to type 2 diabetes mellitus','Hypoglycemia','Type 2',
    80394007,'Hyperglycemia (disorder)','Hyperglycemia','Not stated',
    46635009,'Diabetes mellitus type 1 (disorder)','General','Type 1',
    44054006,'Diabetes mellitus type 2 (disorder)','General','Type 2',
    14140009,'Hyperkalemia (disorder)','Hyperkalemia','Not stated',
  )

# Check all diagnoses to assign each patient to either type 1 or type 2
g_type_1_codes <- c(
  '367991000119101',
  '721283000',
  '420270002',
  '421075007',
  '1571000119104',
  '137941000119106',
  '368561000119102',
  '428896009',
  '190330002',
  '368551000119104',
  '237633009',
  '84371000119108',
  '421437000',
  '120711000119108',
  '46635009',
  '46635009'
)

g_type_2_codes <- c(
  '368051000119109',
  '395204000',
  '721284006',
  '421750000',
  '421847006',
  '701000119103',
  '137931000119102',
  '190331003',
  '761000119102',
  '111231000119109',
  '719216001',
  '119831000119106',
  '44054006'
)

# Derive diagnosis and diabetes type for each record
a.ed_diabetes <-
  a.ed_diabetes %>%  
  left_join(g_diabetes_snomed %>% 
              mutate(ID = as.character(ID)), 
            by = c("EC_Diagnosis_01" = "ID")) %>% 
  mutate(diabetes_type_flag = case_when(
    str_detect(Der_EC_Diagnosis_All, paste(g_type_1_codes, collapse = "|")) ~ "Type_1",
    str_detect(Der_EC_Diagnosis_All, paste(g_type_2_codes, collapse = "|")) ~ "Type_2",
    TRUE ~ "Unknown")) 

# Check totals
a.ed_diabetes %>% 
  group_by(diabetes_type_flag) %>% summarise(n= n())

# # A tibble: 3 x 2
# diabetes_type_flag      n
# <chr>               <int>
# 1 Type_1              28406
# 2 Type_2              34317
# 3 Unknown            182427

a.ed_diabetes %>% 
  select(Der_AEA_Diagnosis_All) %>% 
  group_by(Der_AEA_Diagnosis_All) %>% summarise(n= n())

# AEA diagnosis isn't granular enough 
# AEA_Diagnosis	AEA_Diagnosis_Desc	
# 301	301: Diabetes and other endocrinological conditions - Diabetic	
# 302	302: Diabetes and other endocrinological conditions - Other non-diabetic	

# Check whether a record has both type 1 and type 2 flag
a.ed_diabetes %>% 
  select(Der_EC_Diagnosis_All) %>% 
  mutate(diabetes_type1_flag = case_when(
    str_detect(Der_EC_Diagnosis_All, paste(g_type_1_codes, collapse = "|")) ~ "Type_1",
    TRUE ~ "NA")) %>% 
  mutate(diabetes_type2_flag = case_when(
    str_detect(Der_EC_Diagnosis_All, paste(g_type_2_codes, collapse = "|")) ~ "Type_2",
    TRUE ~ "NA",
  )) %>% 
  filter(diabetes_type1_flag == "Type_1" &
           diabetes_type2_flag == "Type_2") # 108 records

# Patient index
g_diabetes_demographic_index <-
  a.ed_diabetes %>% 
  select(
    EC_Ident,
    Der_Pseudo_NHS_Number ,
    Der_Postcode_LSOA_2011_Code,
    Age_At_Arrival,
    Der_EC_Arrival_Date_Time,
    Index_Of_Multiple_Deprivation_Decile_Description,
    Rural_Urban_Indicator,
    Sex,
    Ethnic_Category,
    EC_Diagnosis_01,
    EC_Decision_To_Admit_Date,
    Der_EC_Duration,
    Provider_Code,
    diabetes_type_flag,
    Description,
    Chapter
  ) %>%  
  # Severity
  mutate(Severity = 
           case_when(Der_EC_Duration <= 240 & is.na(EC_Decision_To_Admit_Date) ~ "<4hrs then Home", # 4 hrs then home
                     Der_EC_Duration > 240 & Der_EC_Duration <= 720 & 
                       is.na(EC_Decision_To_Admit_Date) ~ "4-12hrs then Home", # 4-12hrs then home
                     Der_EC_Duration <= 720 & is.na(EC_Decision_To_Admit_Date) ~ "12+hrs then Home",
                     !is.na(EC_Decision_To_Admit_Date) ~ "Admitted ", 
                     TRUE ~ "NA" )) %>%
  # Ethnicity
  mutate(Der_EC_Arrival_Date_Time = as.Date(Der_EC_Arrival_Date_Time)) %>% 
  mutate(
    Ethnic_Category = case_when(Ethnic_Category %in% c("99", "NA") ~ Ethnic_Category,
                                TRUE ~ substr(Ethnic_Category,1,1)
    )) %>% # Shorten Ethnic group to first character to clean data (except when coded as 99 or NA)
  mutate(
    Ethnic_Category = case_when(is.na(Ethnic_Category) ~ "99",
                                TRUE ~ Ethnic_Category)) %>% # Replace NA's with "NA" to left_join to "Not Known"
  left_join(c_ethnicity_lookup, by = c("Ethnic_Category")) %>% 
  # Age range 
  mutate(Age_range = case_when(Age_At_Arrival >= 0 & Age_At_Arrival < 20 ~ "0-19",
                               (Age_At_Arrival >= 20 & Age_At_Arrival <40) ~  "20-39",
                               (Age_At_Arrival >= 40 & Age_At_Arrival <60) ~  "40-59",
                               (Age_At_Arrival >= 60 & Age_At_Arrival <80) ~  "60-79",
                               (Age_At_Arrival >= 80 & Age_At_Arrival <100) ~ "80-99",
                               Age_At_Arrival>= 100 ~ "100+")) %>% 
  mutate(Age_range = factor(Age_range, levels = c("0-19", 
                                                  "20-39",
                                                  "40-59",
                                                  "60-79",
                                                  "80-99", 
                                                  "100+"))) %>% 
  # Geography
  left_join(a_lsoa_to_stp, by = c("Der_Postcode_LSOA_2011_Code" = "lsoa11cd")) %>% 
  left_join(a_stp_to_nhsr %>% 
              select(stp20cd, nhser20cd, nhser20nm) %>% 
              distinct(), 
            by = c("stp20cd")) %>% 
  # Group and summarise
  group_by(Der_EC_Arrival_Date_Time, 
           nhser20nm, 
           Age_range, 
           Sex,
           Ethnic_Category_Desc, 
           Ethnicity_broad, 
           Index_Of_Multiple_Deprivation_Decile_Description,
           Severity,
           EC_Diagnosis_01,
           EC_Decision_To_Admit_Date,
           Der_EC_Duration,
           diabetes_type_flag,
           Description,
           Chapter
  ) %>% 
  summarise(Admission_count = n_distinct(EC_Ident)) %>% 
  ungroup() %>% 
  rename(Arrival_Date = Der_EC_Arrival_Date_Time, 
         IMD_Decile = Index_Of_Multiple_Deprivation_Decile_Description) %>% 
  mutate(IMD_Quintile = case_when(
    IMD_Decile %in% c("Most deprived 10%","More deprived 10-20%") ~ 1,
    IMD_Decile %in% c("More deprived 20-30%", "More deprived 30-40%") ~ 2,
    IMD_Decile %in% c("More deprived 40-50%","Less deprived 40-50%%") ~ 3,
    IMD_Decile %in% c("Less deprived 30-40%","Less deprived 20-30%") ~ 4,
    IMD_Decile %in% c("Less deprived 10-20%","Least deprived 10%%") ~ 5,
  ))


## G.1.1. Compare diabetes ED attendances and emergency IP admissions ####
a.diabetes_ip_unplanned_index %>% 
  mutate(Admission_week = floor_date(as.Date(Admission_Date), unit = "week")) %>% 
  group_by(Admission_week) %>% 
  summarise(IP_Unplanned = sum(Admission_count)) %>% 
  filter(substr(Admission_week,1,4) < 2021) %>% 
  left_join(
    a.diabetes_ip_planned_index %>% 
      mutate(Admission_week = floor_date(as.Date(Admission_Date), unit = "week")) %>% 
      group_by(Admission_week) %>% 
      summarise(IP_Planned = sum(Admission_count)) %>% 
      filter(substr(Admission_week,1,4) < 2021),
    by = c("Admission_week")
  ) %>% 
  left_join(
    g_diabetes_demographic_index %>%
      mutate(Admission_week = floor_date(as.Date(Arrival_Date), unit = "week")) %>%
      group_by(Admission_week) %>% 
      summarise(ED_Attendances = sum(Admission_count)) %>% 
      filter(substr(Admission_week,1,4) < 2021),
    by = c("Admission_week")
  ) %>% 
  pivot_longer(cols = -Admission_week, 
               names_to = "Admissions", 
               values_to = "Count") %>% 
  
  ggplot(aes(x = Admission_week, y = Count, colour = Admissions)) + 
  geom_smooth(method = 'loess', span = 0.3) +
  scale_color_SU(palette = "main") +
  labs(x = "Week", 
       y = "Admissions/attendances",
       title = "Sharp increase in ED activity is likely fueled by increased data completeness quality",
       subtitle = "Weekly activity for Diabetes - Type 1 and 2", 
       caption = "Emergency department (ED) attendances and Inpatient (planned and unplanned) admissions, National 2018-20")


## G.2. Diabetes attendances - National and regional deficit ####
# Calculate weekly diabetes attendances
g_diabetes_week_number <-
  g_diabetes_demographic_index %>%
  group_by(Arrival_Date) %>% 
  summarise(n_attendances = sum(Admission_count)) %>% 
  mutate(year = year(Arrival_Date),
         month = months(Arrival_Date), 
         week_number = isoweek(Arrival_Date)) %>% 
  group_by(year, week_number) %>% 
  summarise(weekly_admissions = sum(n_attendances)) %>% 
  ungroup()

g_diabetes_week_number_wide <-
  g_diabetes_week_number %>% 
  filter(year == 2020) %>% 
  rename(n_2020 = weekly_admissions) %>% 
  select(-year) %>% 
  left_join(g_diabetes_week_number %>% 
              filter(year == 2018) %>% 
              select(-year) %>% 
              rename(n_2018 = weekly_admissions), by = c("week_number"), keep = FALSE) %>% 
  left_join(g_diabetes_week_number %>% 
              filter(year == 2019) %>% 
              select(-year) %>% 
              rename(n_2019 = weekly_admissions), by = c("week_number"), keep = FALSE) %>% 
  group_by(week_number) %>% 
  mutate(Avg1819 =  round(mean(c(n_2018, n_2019), na.rm=T))) %>% 
  ungroup() %>% 
  mutate(def = n_2019 - n_2020) %>%  # Switch def from 2020-2018/19 to 2020 - 2019
  mutate(PC_def = case_when(
    week_number < 13 ~ as.numeric(0),
    week_number >= 13 ~ as.numeric(n_2019 - n_2020))) %>%  # Additional variable to start deficit from lockdown start
  ungroup()

# Plot year-on-year ED trend
g_diabetes_week_number_wide %>% 
  pivot_longer(cols = -week_number,
               names_to = "trend",
               values_to = "count") %>% 
  filter(trend != c("def", "PC_def")) %>% 
  
  ggplot(aes(x = week_number, y = count, colour = trend)) +
  geom_smooth(method = "loess", span = 0.3) + 
  scale_colour_manual(values = c("#f9bf07", "#686f73", "#5881c1", "#ec6555")) +
  labs(title = "Year on year ED attendances for diabetes", 
       subtitle = "National", 
       x = "Week", y = "Attendance count")

g_diabetes_annual_trends <-
  g_diabetes_week_number_wide %>%   
  ggplot(aes(x = week_number, y = n_2020)) +
  geom_smooth(method = "loess", span = 0.3, colour = "#f9bf07") +
  geom_smooth(aes(y = n_2019), method = "loess", span = 0.3, colour = "#5881c1") +
  #geom_smooth(aes(y = n_2019), method = "loess", span = 0.3, colour = "red") +
  #geom_smooth(aes(y = n_2018), method = "loess", span = 0.3, colour = "green") +
  # Covid timeline markers
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 1800, label = str_wrap("National lockdown", 10) ,size = 3.5) +
  annotate("text", x = 34, y = 1800, label = str_wrap("Recovery period", 10) ,size = 3.5) +
  annotate("text", x = 48, y = 1800, label = str_wrap("3 Tier lockdown", 10) ,size = 3.5) +
  # Labels and arrows 
  annotate(geom = "curve", x = 29, y = 1100, xend = 20, yend = 1200, 
           curvature = -0.3, arrow = arrow(length = unit(2, "mm"))) +
  annotate(geom = "curve", x = 21, y = 1700, xend = 24, yend = 1605, 
           curvature = -0.3, arrow = arrow(length = unit(2, "mm"))) +
  annotate("text", x = 31, y = 1100, label = str_wrap("2020",10), size = 3) +
  annotate("text", x = 18, y = 1700, label = "2019", size = 3) +
  labs(x = "Week number", y = "Attendances")

# Visualise admission deficit 
g_diabetes_admission_def_vis <-
  g_diabetes_week_number_wide %>% 
  ggplot(aes(x = week_number, y = PC_def)) +
  geom_hline(aes(yintercept = 0)) +
  geom_smooth(method = "loess", span = 0.3, colour = "#f9bf07") +
  # Covid timeline markers
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 600, label = str_wrap("National lockdown", 10) ,size = 3.5) +
  annotate("text", x = 34, y = 600, label = str_wrap("Recovery period", 10) ,size = 3.5) +
  annotate("text", x = 48, y = 600, label = str_wrap("3 Tier lockdown", 10) ,size = 3.5) +
  labs(x = "Week number", y = "Avoided attendances")

# Patch
g_diabetes_annual_trends + g_diabetes_admission_def_vis + 
  plot_annotation(title = "Yearly patterns in diabetes emergency attendances",
                  subtitle = "National, Weekly elective inpatient procedures, 2018-20")

# Function: get admission count and deficit by demographic 
g_get_admission_deficit_diabetes <- function(demographic_var) {
  
  g_diabetes_demographic_index <- 
    g_diabetes_demographic_index %>%
    mutate(demographic_var = {{demographic_var}})
  
  sub_data <-
    g_diabetes_demographic_index %>% 
    mutate(year = year(Arrival_Date),
           month = months(Arrival_Date), 
           week_number = isoweek(Arrival_Date)) %>% 
    group_by(year, week_number, demographic_var) %>% 
    summarise(weekly_attendances = sum(Admission_count)) %>% 
    ungroup()
  
  sub_data_wide <-
    sub_data %>% 
    filter(year == 2020) %>% 
    rename(n_2020 = weekly_attendances) %>% 
    select(-year) %>% 
    left_join(sub_data %>% 
                filter(year == 2018) %>% 
                select(-year) %>% 
                rename(n_2018 = weekly_attendances), by = c("week_number", 'demographic_var'), keep = FALSE) %>% 
    left_join(sub_data %>% 
                filter(year == 2019) %>% 
                select(-year) %>% 
                rename(n_2019 = weekly_attendances), by = c("week_number", 'demographic_var'), keep = FALSE) %>% 
    group_by(week_number, demographic_var) %>% 
    mutate(Avg1819 =  round(mean(c(n_2018, n_2019), na.rm=T))) %>% 
    mutate(def = n_2020 - n_2019) %>% 
    mutate(PC_def = case_when(
      week_number < 13 ~ as.numeric(0),
      week_number >= 13 ~ as.numeric(n_2020 - n_2019))) %>%  # Additional variable to start deficit from lockdown start
    ungroup()
  
  sub_data_wide
}

# Function: Plot 2020 vs 2018/19 average, facet by demographic
facet_plot_function_diabetes <- function(data) {
  
  data %>% 
    pivot_longer(cols = c(-week_number, - demographic_var),
                 names_to = "trend", 
                 values_to = "Attendance_count") %>% 
    filter(trend %in% c("n_2020", "n_2019")) %>% 
    mutate(trend = case_when(trend == "n_2020" ~ "2020",
                             trend == "n_2019" ~ "2019"))  %>% 
    
    ggplot(aes(x = week_number, y = Attendance_count, colour = trend, group = trend)) +
    geom_smooth(method = "loess", span = 0.3) +
    scale_colour_manual(values = c("#5881c1", "#f9bf07")) +
    facet_wrap(~ demographic_var, scales = "free") +
    # Covid timeline markers
    annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
    annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
    annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
    theme(strip.text = element_text(size = 10, face = "bold"),
          legend.text = element_text(size = 12)) +
    labs(colour = "")
}

# Region (not using the function above)
g_get_admission_deficit_diabetes(nhser20nm) %>% 
  drop_na(demographic_var) %>% 
  pivot_longer(cols = c(-week_number, - demographic_var),
               names_to = "trend", 
               values_to = "Attendance_count") %>% 
  filter(trend %in% c("n_2020", "n_2019")) %>% 
  mutate(trend = case_when(trend == "n_2020" ~ "2020",
                           trend == "n_2019" ~ "2019"))  %>% 
  
  ggplot(aes(x = week_number, y = Attendance_count, colour = trend, group = trend)) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_colour_manual(values = c("#5881c1", "#f9bf07")) +
  facet_wrap(~ demographic_var) +
  # Covid timeline markers
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 375, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  annotate("text", x = 34, y = 375, label = str_wrap("Recovery", 10) ,size = 2.5) +
  annotate("text", x = 48, y = 375, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  theme(strip.text = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = c(0.85, 0.2)) +
  labs(x = "Week number", y = "Attendances", colour = "",
       title = "Most variation from the previous year's norm occurs during lockdown 1",
       subtitle = "ED attendances for diabetes in 2019 and 2020 by NHSE region")

# Regional deficit 
g_diab_ed_deficit_cum_region <-
g_get_admission_deficit_diabetes(nhser20nm) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_def)) 


g_diab_ed_deficit_cum_region_vis <-
g_diab_ed_deficit_cum_region %>% 
  ggplot(aes(x = week_number, y = cum_def)) +
  geom_hline(yintercept = 0, colour = "#636363") +
  # Covid timeline markers
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 200, label = str_wrap("National lockdown", 10) ,size = 2.5) +
  annotate("text", x = 34, y = 200, label = str_wrap("Recovery period", 10) ,size = 2.5) +
  annotate("text", x = 48, y = 200, label = str_wrap("3 Tier lockdown", 10) ,size = 2.5) +
  geom_smooth(method = "loess", span = 0.3, colour = "#f9bf07") +
  facet_wrap(~demographic_var) +
  theme(strip.text = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 12)) +
  labs(x = "Week number",
       y = "Cumulative difference",
       title = "North East and Yorkshire displays a concerning and growing attendance deficit", 
       subtitle = "Cumulative difference in emergency attendances for diabetes complications, National",
       caption = "Difference = change between expected ED attendances seen in 2019 and 2020 attendance count")


# Regional deficit proportion 

g_diab_ed_deficit_prop_region <-
  g_get_admission_deficit_diabetes(nhser20nm) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_def = sum(PC_def, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(def_prop = round(sum_def/sum_2019*100,2)) %>% 
  arrange(desc(def_prop)) %>% 
  mutate(sum_def_adj = 
           case_when(sum_def >= 0 ~ sum_def,
                     sum_def < 0 ~ -sum_def )) %>% # Switch out the negative def to positive to calcuate CI
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_def_adj, n = sum_2019,0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_def_adj, n = sum_2019,0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_def >= 0 ~ LCI, sum_def < 0 ~ -LCI),
         UCI = case_when(sum_def >= 0 ~ UCI, sum_def < 0 ~ -UCI))  # Return CI's to negative where the def was negative

g_diab_ed_deficit_prop_region_vis <-
g_diab_ed_deficit_prop_region %>% 
  ggplot(aes(y = reorder(demographic_var, def_prop), x = def_prop)) +
  geom_col(fill = "#f9bf07", colour = "grey") +
  geom_errorbar(aes(xmin = LCI, xmax = UCI), width = 0.25, colour = "#636363") +
  labs(title = "North East and Yorkshire experienced the greater disruption to ED diabetes care", 
       subtitle = "Diabetes ED attendance change due to covid-19 pandemic, by NHSE region",
       caption = "Change as a proportion of total expected attendances seen in '2019",
       x = "Attendance change proportion", 
       y = "NHSE region")



## G.3 Demographic deficits ####

# Broad ethnicity
facet_plot_function_diabetes(g_get_admission_deficit_diabetes(Ethnicity_broad) %>% 
                               drop_na(demographic_var)) +
  labs(x = "Week number", y = "Attendances", colour = "",
       title = "White and Asian populations have the clearest attendance excesses",
       subtitle = "ED diabetes attendances in 2019 and 2020: Attendances by broad ethnicity")

# Broad ethnicity - cumulative deficit 
g_get_admission_deficit_diabetes(Ethnicity_broad) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_def)) %>% 
  
  ggplot(aes(x = week_number, y = cum_def)) +
  geom_hline(yintercept = 0, colour = "#636363") +
  # Covid timeline markers
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 0, label = str_wrap("National lockdown", 10) ,size = 2.5) +
  annotate("text", x = 34, y = 0, label = str_wrap("Recovery period", 10) ,size = 2.5) +
  annotate("text", x = 48, y = 0, label = str_wrap("3 Tier lockdown", 10) ,size = 2.5) +
  geom_smooth(method = "loess", span = 0.3, colour = "#f9bf07") +
  facet_wrap(~demographic_var) +
  theme(strip.text = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 12)) +
  labs(x = "Week number",
       y = "Cumulative deficit",
       title = "A deficit has emerged and sustained in White and Asain ethnicities due to covid-19", 
       subtitle = "Cumulative emergency attendance deficit for diabetes complications, Deficit by ethnicity, National",
       caption = "Deficit = difference between 2020 attendance count and expected ED attendances seen in 2019")

# Ethnicity - deficit proportion 
g_diab_ed_deficit_prop_broad_ethnicity <-
  g_get_admission_deficit_diabetes(Ethnicity_broad) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_def = sum(PC_def, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(def_prop = round(sum_def/sum_2019*100,2)) %>% 
  arrange(desc(def_prop)) %>% 
  mutate(sum_def_adj = 
           case_when(sum_def >= 0 ~ sum_def,
                     sum_def < 0 ~ -sum_def )) %>% # Switch out the negative def to positive to calcuate CI
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_def_adj, n = sum_2019,0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_def_adj, n = sum_2019,0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_def >= 0 ~ LCI, sum_def < 0 ~ -LCI),
         UCI = case_when(sum_def >= 0 ~ UCI, sum_def < 0 ~ -UCI))  # Return CI's to negative where the def was negative

g_diab_ed_deficit_prop_broad_ethnicity %>% 
  ggplot(aes(y = reorder(demographic_var, def_prop), x = def_prop)) +
  geom_col(fill = "#f9bf07", colour = "grey") +
  geom_errorbar(aes(xmin = LCI, xmax = UCI), width = 0.25, colour = "#636363") +
  labs(title = "The deficit in White and Asian populations is largest in absolute and relative terms", 
       subtitle = "Diabetes ED attendance deficit due to covid-19 pandemic, by broad ethnicity",
       caption = "Deficit as a proportion of total expected admissions seen in '2019",
       x = "Admission deficit proportion", 
       y = "Broad ethnicity")


# Deprivation
facet_plot_function_diabetes(g_get_admission_deficit_diabetes(IMD_Quintile) %>% 
                               drop_na(demographic_var)) +
  labs(x = "Week number", y = "Admissions", colour = "",
       title = "",
       subtitle = "ED diabetes attendances in 2019 and 2020: Attendances by IMD Quintile")

# Deprivation - cumulative deficit 
g_get_admission_deficit_diabetes(IMD_Quintile) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_def)) %>% 
  
  ggplot(aes(x = week_number, y = cum_def)) +
  geom_hline(yintercept = 0, colour = "#636363") +
  # Covid timeline markers
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 0, label = str_wrap("National lockdown", 10) ,size = 2.5) +
  annotate("text", x = 34, y = 0, label = str_wrap("Recovery period", 10) ,size = 2.5) +
  annotate("text", x = 48, y = 0, label = str_wrap("3 Tier lockdown", 10) ,size = 2.5) +
  geom_smooth(method = "loess", span = 0.3, colour = "#f9bf07") +
  facet_wrap(~demographic_var) +
  theme(strip.text = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 12)) +
  labs(x = "Week number",
       y = "Cumulative deficit",
       title = "Pre-pandemic excess are seen in all quintiles, with poor groups experiencing larger subsequent deficits", 
       subtitle = "Cumulative emergency attendance deficit for diabetes complications, Deficit by deprivation, National",
       caption = "Deficit = difference between 2020 attendance count and expected ED attendances seen in 2019")


# Deprivation - deficit proportion 
g_diab_ed_deficit_prop_broad_deprivation <-
  g_get_admission_deficit_diabetes(IMD_Quintile) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_def = sum(PC_def, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(def_prop = round(sum_def/sum_2019*100,2)) %>% 
  arrange(desc(def_prop)) %>% 
  mutate(sum_def_adj = 
           case_when(sum_def >= 0 ~ sum_def,
                     sum_def < 0 ~ -sum_def )) %>% # Switch out the negative def to positive to calcuate CI
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_def_adj, n = sum_2019,0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_def_adj, n = sum_2019,0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_def >= 0 ~ LCI, sum_def < 0 ~ -LCI),
         UCI = case_when(sum_def >= 0 ~ UCI, sum_def < 0 ~ -UCI))  # Return CI's to negative where the def was negative

g_diab_ed_deficit_prop_broad_deprivation %>% 
  ggplot(aes(y = reorder(demographic_var, -demographic_var), x = def_prop)) +
  geom_col(fill = "#f9bf07", colour = "grey") +
  geom_errorbar(aes(xmin = LCI, xmax = UCI), width = 0.25, colour = "#636363") +
  labs(title = "Disruption in emergency diabetes attendances is skewed towards the poorest half of the population", 
       subtitle = "Diabetes ED attendance deficit due to covid-19 pandemic, by deprivation quintile",
       caption = "Deficit as a proportion of total expected admissions seen in '2019",
       x = "Admission deficit proportion", 
       y = "IMD Quintile")

# Age range 
facet_plot_function_diabetes(g_get_admission_deficit_diabetes(Age_range) %>% 
                               drop_na(demographic_var)) +
  labs(x = "Week number", y = "Admissions", colour = "",
       title = "...",
       subtitle = "ED diabetes attendances in 2019 and 2020: Attendances by Age range")

# Age range - cumulative deficit 
g_get_admission_deficit_diabetes(Age_range) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_def)) %>% 
  
  ggplot(aes(x = week_number, y = cum_def)) +
  geom_hline(yintercept = 0, colour = "#636363") +
  # Covid timeline markers
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 0, label = str_wrap("National lockdown", 10) ,size = 2.5) +
  annotate("text", x = 34, y = 0, label = str_wrap("Recovery period", 10) ,size = 2.5) +
  annotate("text", x = 48, y = 0, label = str_wrap("3 Tier lockdown", 10) ,size = 2.5) +
  geom_smooth(method = "loess", span = 0.3, colour = "#f9bf07") +
  facet_wrap(~demographic_var) +
  theme(strip.text = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 12)) +
  labs(x = "Week number",
       y = "Cumulative deficit",
       title = "...", 
       subtitle = "Cumulative emergency attendance deficit for diabetes complications, Deficit by Age range, National",
       caption = "Deficit = difference between 2020 attendance count and expected ED attendances seen in 2019")


# Age range - deficit proportion 
g_diab_ed_deficit_prop_Age_range <-
  g_get_admission_deficit_diabetes(Age_range) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_def = sum(def, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(def_prop = round(sum_def/sum_2019*100,2)) %>% 
  arrange(desc(def_prop)) %>% 
  mutate(sum_def_adj = 
           case_when(sum_def >= 0 ~ sum_def,
                     sum_def < 0 ~ -sum_def )) %>% # Switch out the negative def to positive to calcuate CI
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_def_adj, n = sum_2019,0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_def_adj, n = sum_2019,0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_def >= 0 ~ LCI, sum_def < 0 ~ -LCI),
         UCI = case_when(sum_def >= 0 ~ UCI, sum_def < 0 ~ -UCI))  # Return CI's to negative where the def was negative

g_diab_ed_deficit_prop_Age_range %>% 
  ggplot(aes(y = reorder(demographic_var, demographic_var), x = def_prop)) +
  geom_col(fill = "#f9bf07", colour = "grey") +
  geom_errorbar(aes(xmin = LCI, xmax = UCI), width = 0.25, colour = "#636363") +
  labs(title = "...", 
       subtitle = "Diabetes ED attendance deficit due to covid-19 pandemic, by Age range",
       caption = "Deficit as a proportion of total expected admissions seen in '2019",
       x = "Admission deficit proportion", 
       y = "Age range")

## G.4 Clinical trends ####
## G.4.1 Diabetes attendances by severity ####
g_diabetes_demographic_index %>% 
  mutate(Attendance_week = floor_date(Arrival_Date, unit = "week")) %>% 
  group_by(Attendance_week, Severity) %>% 
  summarise(n_attendances = sum(Admission_count)) %>%  #sum monthly attendances %>% 
  filter(Severity != "NA") %>% 
  
  ggplot(aes(x = Attendance_week, y = n_attendances, colour = Severity)) + 
  annotate("rect", xmin = as.Date("2020-03-23"), xmax = as.Date("2020-07-04"), ymin = 0, ymax = Inf, 
           fill= "#fed976", alpha = 0.6) + # Lockdown 1
  annotate("rect", xmin = as.Date("2020-10-14"), xmax = as.Date("2021-01-04"), ymin = 0, ymax = Inf, 
           fill= "#fed976", alpha = 0.6) + # 3 tier system
  annotate("text", x = as.Date("2020-05-13"), y = 800, label = "National lockdown",size = 3, angle = 90) +
  annotate("text", x = as.Date("2020-11-24"), y = 800, label = "3 Tier lockdown",size = 3, angle = 90) +
  geom_smooth(method = "loess", span = 0.3) +
  labs(x = "Week", 
       y = "Attenances",
       title = "Emergency department attendences for diabetes by attendance severity",
       subtitle = "National, 2018-20")


## G.4.2 Primary diagnosis ####

#g.con <- dbConnect(odbc(), 
#                   Driver = "SQL Server", 
#                   server = "PRODNHSESQL101", 
#                   Database = "NHSE_Reference")
#
#g.chief_complaint_ref <-
#  as_tibble(
#    dbGetQuery(g.con, '
#select *
#from [NHSE_Reference].[dbo].[tbl_Ref_DataDic_ECDS_Chief_Complaint]'))
#
## Disconnect! # 
#dbDisconnect(g.con) 

# # Chief complaint
# g_diabetes_demographic_index %>% 
#   left_join(g.chief_complaint_ref %>% 
#               mutate(ChiefComplaintCode = as.character(ChiefComplaintCode)), 
#             by = c("EC_Chief_Complaint_SNOMED_CT" = "ChiefComplaintCode")) %>% 
#   group_by(ChiefComplaintDescription) %>% 
#   summarise(n = sum(Admission_count)) %>% 
#   arrange(desc(n))

# # EC_Diagnosis_01
# g_diabetes_demographic_index %>% 
#   left_join(g_diabetes_snomed %>% 
#               mutate(ID = as.character(ID)), 
#             by = c("EC_Diagnosis_01" = "ID")) %>% 
#   group_by(Description, diabetes_type) %>% 
#   summarise(n = sum(Admission_count)) %>% 
#   arrange(desc(n))
# 
# # Result: Use EC_Diagnosis_01 as primary diagnosis, Chief_complaint is limitted to 230ish snomed-ct codes - limited diabtes to hypo or hyperglycaemia
# 
# g_diabetes_demographic_index_diag <-
#   g_diabetes_demographic_index %>% 
#   left_join(g_diabetes_snomed %>% 
#               mutate(ID = as.character(ID)), 
#             by = c("EC_Diagnosis_01" = "ID"))
# 
# g_diabetes_demographic_index_diag %>% 
#   group_by(diabetes_type) %>% 
#   summarise(n = sum(Admission_count))


# Diabetes type flag 
g_diabetes_demographic_index %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, diabetes_type_flag) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  
  ggplot(aes(x = Admission_week, y = Activity, colour = diabetes_type_flag)) +
  geom_smooth(method = "loess", span = 0.3)


# Primary diagnosis (Description) 
g_diabetes_demographic_index %>% 
  group_by(Description) %>% summarise(n = n())

# # A tibble: 7 x 2
# Description                             n
# <chr>                               <int>
# 1 Diabetes mellitus type 1 (disorder) 24990
# 2 Diabetes mellitus type 2 (disorder) 28156
# 3 Diabetic ketoacidosis               50900
# 4 Hyperglycemia (disorder)            24360
# 5 Hyperkalemia (disorder)             30620
# 6 Hypoglycemia                        57662
# 7 NA                                  28415

# Changing rate of diabetes admissions by diagnosis 
g_diabetes_demographic_index %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, Description) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  drop_na(Description) %>% 
  filter(Admission_week > "2019-01-01") %>% 
  
  ggplot(aes(x = Admission_week, y = Activity, colour = Description)) +
  geom_smooth(method = "loess", span = 0.3) 

## Type 1: Changing rates of attendances  ####
g_type1_weekly_count <- 
g_diabetes_demographic_index %>% 
  filter(Description == "Diabetes mellitus type 1 (disorder)") %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  filter(Admission_week > "2019-01-01" &
           Admission_week < "2020-12-31") 

g_type1_weekly_count_vis <-
g_type1_weekly_count %>%
  ggplot(aes(x = Admission_week, y = Activity)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 160, label = str_wrap("Lockdown", 10) ,size = 3, angle = 90) +
  annotate("text", x = as.Date("2020-08-24"), y = 160, label = str_wrap("Recovery", 10) ,size = 3, angle = 90) +
  annotate("text", x = as.Date("2020-11-24"), y = 160, label = str_wrap("Lockdown", 10) ,size = 3, angle = 90) +
  geom_smooth(method = "loess", span = 0.3, colour = "#f9bf07") +
  labs(x = "Date", y = "Count",
       title = "ED attendances for Type 1 diabetes have not yet returned to pre-pandemic levels",
       subtitle = "Weekly count of ED attenance for Type 1 Diabetes, National 2019-20")
  
# Break this down by demographic
# Region
g_type1_weekly_count_region <-
g_diabetes_demographic_index %>% 
  filter(Description == "Diabetes mellitus type 1 (disorder)") %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, nhser20nm) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  filter(Admission_week > "2019-01-01" &
           Admission_week < "2020-12-31") %>% 
  drop_na(nhser20nm) %>% 
  ungroup() 

g_type1_weekly_count_region_vis <-
g_type1_weekly_count_region %>%
  ggplot(aes(x = Admission_week, y = Activity, colour = nhser20nm)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("Recovery", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  geom_smooth(method = "loess", span = 0.3, se = TRUE) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y = "Count", color = "NHSE Region",
       title = "ED attendances appear to have been reducing prior to lockdown",
       subtitle = "Weekly count of ED attenance for Type 1 Diabetes, by Region, National 2019-20")

# Age
g_type1_weekly_count_age <-
g_diabetes_demographic_index %>% 
  filter(Description == "Diabetes mellitus type 1 (disorder)") %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, Age_range) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  filter(Admission_week > "2019-01-01" &
           Admission_week < "2020-12-31") %>% 
  drop_na(Age_range) 

g_type1_weekly_count_age_vis <-
g_type1_weekly_count_age %>% 
  ggplot(aes(x = Admission_week, y = Activity, colour = Age_range, group = Age_range)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("Recovery", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y = "Count", color = "Age range",
       title = "Attendance rates for older patients were less affected by the pandemic",
       subtitle = "Weekly count of ED attenance for Type 1 Diabetes, by Age range, National 2019-20")

# Deprivation 
g_type1_weekly_count_deprivation <-
g_diabetes_demographic_index %>% 
  filter(Description == "Diabetes mellitus type 1 (disorder)") %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, IMD_Quintile) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  filter(Admission_week > "2019-01-01" &
           Admission_week < "2020-12-31") %>% 
  drop_na(IMD_Quintile) %>% 
  mutate(IMD_Quintile = factor(IMD_Quintile, levels = c(1,2,3,4,5))) 


g_type1_weekly_count_deprivation_vis <-
g_type1_weekly_count_deprivation %>%
  ggplot(aes(x = Admission_week, y = Activity, colour = IMD_Quintile, group = IMD_Quintile)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("Recovery", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y = "Count", color = "IMD Quintile",
       title = "ED attendances are more frequent in deprived patients",
       subtitle = "Weekly count of ED attenance for Type 1 Diabetes, by IMD Quintile, National 2019-20")

# Broad ethnicity
g_type1_weekly_count_ethnicity_broad <-
g_diabetes_demographic_index %>% 
  filter(Description == "Diabetes mellitus type 1 (disorder)") %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, Ethnicity_broad) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  filter(Admission_week > "2019-01-01" &
           Admission_week < "2020-12-31") %>% 
  drop_na(Ethnicity_broad) 

g_type1_weekly_count_ethnicity_broad_vis <-
g_type1_weekly_count_ethnicity_broad %>%
  ggplot(aes(x = Admission_week, y = Activity, colour = Ethnicity_broad, group = Ethnicity_broad)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("Recovery", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y = "Count", color = "Broad ethnicity",
       title = "...",
       subtitle = "Weekly count of ED attenance for Type 1 Diabetes, by broad ethnicity, National 2019-20")

# Broad ethnicity - facet 
g_type1_weekly_count_ethnicity_broad_facet_vis <-
g_type1_weekly_count_ethnicity_broad %>%  
  ggplot(aes(x = Admission_week, y = Activity, colour = Ethnicity_broad, group = Ethnicity_broad)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("L", 10) ,size = 3) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("R", 10) ,size = 3) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("L", 10) ,size = 3) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU(palette = "main") +
  facet_wrap(~Ethnicity_broad, scales = "free") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, size = 8)) +
  labs(x = "Date", y = "Count", color = "Broad ethnicity",
       title = "Asian, Black and White patients have similar trends in ED attendance",
       subtitle = "Weekly count of ED attenance for Type 1 Diabetes, by broad ethnicity, National 2019-20",
       caption = "L: Lockdown, R: Recovery")

# Severity
g_type1_weekly_count_severity <-
g_diabetes_demographic_index %>% 
  filter(Description == "Diabetes mellitus type 1 (disorder)") %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, Severity) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  filter(Admission_week > "2019-01-01" & Admission_week < "2020-12-31") %>% 
  filter(Severity != "NA") 

g_type1_weekly_count_severity_vis <-
g_type1_weekly_count_severity %>%  
  ggplot(aes(x = Admission_week, y = Activity, colour = Severity, group = Severity)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("Recovery", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y = "Count", color = "Severity",
       title = "Attendances for type 1 diabetes that are treated in and disharged from ED are increasing post-pandemic",
       subtitle = "Weekly count of ED attenance for Type 1 Diabetes, by attendance severity, National 2019-20")


## Type 1: Proportional change in attendances ####
e_get_attendance_diff_type1 <- function(demographic_var) {
  
  g_diabetes_demographic_index <- 
    g_diabetes_demographic_index %>%
    mutate(demographic_var = {{demographic_var}})
  
  sub_data <-
    g_diabetes_demographic_index %>% 
    filter(Description == "Diabetes mellitus type 1 (disorder)") %>% 
    mutate(year = year(Arrival_Date),
           month = months(Arrival_Date), 
           week_number = isoweek(Arrival_Date)) %>% 
    group_by(year, week_number, demographic_var) %>% 
    summarise(weekly_admissions = sum(Admission_count)) %>% 
    ungroup()
  
  sub_data_wide <-
    sub_data %>% 
    filter(year == 2020) %>% 
    rename(n_2020 = weekly_admissions) %>% 
    select(-year) %>% 
    left_join(sub_data %>% 
                filter(year == 2018) %>% 
                select(-year) %>% 
                rename(n_2018 = weekly_admissions), by = c("week_number", 'demographic_var'), keep = FALSE) %>% 
    left_join(sub_data %>% 
                filter(year == 2019) %>% 
                select(-year) %>% 
                rename(n_2019 = weekly_admissions), by = c("week_number", 'demographic_var'), keep = FALSE) %>% 
    group_by(week_number, demographic_var) %>% 
    #mutate(Avg1819 =  round(mean(c(n_2018, n_2019), na.rm=T))) %>% 
    mutate(diff = n_2020 - n_2019) %>% 
    mutate(PC_diff = case_when(
      week_number < 13 ~ as.numeric(0),
      week_number >= 13 ~ as.numeric(n_2020 - n_2019))) %>%  # Additional variable to start deficit from lockdown start
    ungroup() 
  
  sub_data_wide
}

# Region
e_type1_cum_diff_region <-
  e_get_attendance_diff_type1(nhser20nm) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_diff)) %>% 
  pivot_longer(cols = c(-week_number, -demographic_var),
               names_to = "trend", 
               values_to = "count") %>% 
  filter(trend == "cum_def") %>% 
  filter(week_number < 53) %>% 
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  drop_na(demographic_var) 

e_type1_cum_diff_region_vis <-
e_type1_cum_diff_region %>%
  ggplot(aes(x = week_number, y = count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_SU(palette = "main") +
  theme(legend.position = "none") +
  labs(title = "Reductions in type 1 diabetes attendance continued between lockdowns", 
       subtitle = "Cumulative change in weekly attendance count for type 1 diabetes between 2019 and 2020, by NHSE region",
       caption = "Attendance difference = 2020 count - 2019 count",
       x = "Week number",
       y = "Cumulative attendance difference")

# Region - proportional difference between 2019-2020
e_type1_prop_diff_region <-
  e_get_attendance_diff_type1(nhser20nm) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_diff = sum(PC_diff, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(diff_prop = sum_diff/sum_2019*100) %>% 
  mutate(sum_diff_adj = case_when(sum_diff >= 0 ~ sum_diff,
                                  sum_diff < 0 ~ -sum_diff )) %>% 
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_diff >= 0 ~ LCI, sum_diff < 0 ~ -LCI),
         UCI = case_when(sum_diff >= 0 ~ UCI, sum_diff < 0 ~ -UCI)) # Return CI's to negative where the def was negative

e_type1_prop_diff_region_vis <-
e_type1_prop_diff_region %>% 
  ggplot(aes(y = reorder(demographic_var, diff_prop), x = diff_prop)) +
  geom_col(fill = "#f9bf07", colour = "#636363") +
  geom_errorbar(aes(xmin=LCI, xmax=UCI), width = 0.25, colour = "#636363") +
  labs(x = "Proportional change", 
       y = "NHSE Region",
       title = "The Midlands has the largest absolute and proportional reduction in attendances",
       subtitle = "Proportional change in ED attendance count for type 1 diabetes between 2019-20 by NHSE Region",
       caption = "Proportional change = change between 2019-20 / total attendance count for 2019")

# Age
e_type1_cum_diff_age_range <-
  e_get_attendance_diff_type1(Age_range) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_diff)) %>% 
  pivot_longer(cols = c(-week_number, -demographic_var),
               names_to = "trend", 
               values_to = "count") %>% 
  filter(trend == "cum_def") %>% 
  filter(week_number < 53) %>% 
  drop_na(demographic_var) %>% 
  ungroup()

e_type1_cum_diff_age_range_vis <-
e_type1_cum_diff_age_range %>%
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  filter(demographic_var != "100+") %>% 
  ggplot(aes(week_number, count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_SU(palette = "main") +
  theme(legend.position = "none") +
  labs(title = "Attendances continued to drop for all but the under 20's during the recovery period", 
       subtitle = "Cumulative change in weekly attendance count for type 1 diabetes between 2019 and 2020, by Age range",
       caption = "Attendance difference = 2020 count - 2019 count",
       x = "Week number",
       y = "Cumulative attendance difference")

# Age range - proportional difference between 2019-2020
e_type1_prop_diff_age <-
  e_get_attendance_diff_type1(Age_range) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_diff = sum(PC_diff, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(diff_prop = sum_diff/sum_2019*100) %>% 
  mutate(sum_diff_adj = case_when(sum_diff >= 0 ~ sum_diff,
                                  sum_diff < 0 ~ -sum_diff )) %>% 
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_diff >= 0 ~ LCI, sum_diff < 0 ~ -LCI),
         UCI = case_when(sum_diff >= 0 ~ UCI, sum_diff < 0 ~ -UCI))  # Return CI's to negative where the def was negative

e_type1_prop_diff_age_vis <-  
e_type1_prop_diff_age %>% 
  ggplot(aes(y = demographic_var, x = diff_prop)) +
  geom_col(fill = "#f9bf07", colour = "#636363") +
  geom_errorbar(aes(xmin=LCI, xmax=UCI), width = 0.25, colour = "#636363") +
  labs(x = "Proportional change", 
       y = "Age range",
       title = "Proportional change was similar for all over 20's",
       subtitle = "Proportional change in ED attendance count for type 1 diabetes between 2019-20 by age range",
       caption = "Proportional change = change between 2019-20 / total attendance count for 2019")

# Deprivation
e_type1_cum_diff_deprivation <-
  e_get_attendance_diff_type1(IMD_Quintile) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_diff)) %>% 
  pivot_longer(cols = c(-week_number, -demographic_var),
               names_to = "trend", 
               values_to = "count") %>% 
  filter(trend == "cum_def") %>% 
  filter(week_number < 53) %>% 
  drop_na(demographic_var) %>% 
  ungroup() %>% 
  mutate(demographic_var = factor(demographic_var, levels = c(1,2,3,4,5)))

e_type1_cum_diff_deprivation_vis <-
e_type1_cum_diff_deprivation %>%
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  filter(demographic_var != "100+") %>% 
  ggplot(aes(week_number, count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_SU(palette = "main") +
  theme(legend.position = "none") +
  labs(title = "The cumulative reduction in ED attendances increases with deprivation", 
       subtitle = "Cumulative change in weekly attendance count for type 1 diabetes between 2019 and 2020, by IMD Quintile ",
       caption = "Attendance difference = 2020 count - 2019 count",
       x = "Week number",
       y = "Cumulative attendance difference")

# Deprivation - proportional difference between 2019-2020
e_type1_prop_diff_deprivation <-
  e_get_attendance_diff_type1(IMD_Quintile) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_diff = sum(PC_diff, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(diff_prop = sum_diff/sum_2019*100) %>% 
  mutate(sum_diff_adj = case_when(sum_diff >= 0 ~ sum_diff,
                                  sum_diff < 0 ~ -sum_diff )) %>% 
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_diff >= 0 ~ LCI, sum_diff < 0 ~ -LCI),
         UCI = case_when(sum_diff >= 0 ~ UCI, sum_diff < 0 ~ -UCI)) %>%   # Return CI's to negative where the def was negative
  mutate(demographic_var = factor(demographic_var, levels = c(1,2,3,4,5)))

e_type1_prop_diff_deprivation_vis <-
e_type1_prop_diff_deprivation %>% 
  ggplot(aes(y = demographic_var, x = diff_prop)) +
  geom_col(fill = "#f9bf07", colour = "#636363") +
  geom_errorbar(aes(xmin=LCI, xmax=UCI), width = 0.25, colour = "#636363") +
  labs(x = "Proportional change", 
       y = "IMD Quintile",
       title = "The reduction in attendances during the pandemic was lowest in the most affluent 20%",
       subtitle = "Proportional change in ED attendance count for type 1 diabetes between 2019-20 by IMD Quintile",
       caption = "Proportional change = change between 2019-20 / total attendance count for 2019")

# Ethnicity
# Ethnic_Category_Desc
e_type1_cum_diff_ethnicity <-
  e_get_attendance_diff_type1(Ethnicity_broad) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_diff)) %>% 
  pivot_longer(cols = c(-week_number, -demographic_var),
               names_to = "trend", 
               values_to = "count") %>% 
  filter(trend == "cum_def") %>% 
  filter(week_number < 53) %>% 
  drop_na(demographic_var) %>% 
  ungroup() 

e_type1_cum_diff_ethnicity_vis <-
e_type1_cum_diff_ethnicity %>%
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  filter(demographic_var != "100+") %>% 
  ggplot(aes(week_number, count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_SU(palette = "main") +
  theme(legend.position = "none") +
  labs(title = "Reductions in non-White ethnicities are much less pronounced than in the White population", 
       subtitle = "Cumulative change in weekly attendance count for type 1 diabetes between 2019 and 2020, by broad ethnicity",
       caption = "Attendance difference = 2020 count - 2019 count",
       x = "Week number",
       y = "Cumulative attendance difference")

# Ethnicity - proportional difference between 2019-2020
e_type1_prop_diff_ethnicity <-
  e_get_attendance_diff_type1(Ethnic_Category_Desc) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_diff = sum(PC_diff, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(diff_prop = sum_diff/sum_2019*100) %>% 
  mutate(sum_diff_adj = case_when(sum_diff >= 0 ~ sum_diff,
                                  sum_diff < 0 ~ -sum_diff )) %>% 
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_diff >= 0 ~ LCI, sum_diff < 0 ~ -LCI),
         UCI = case_when(sum_diff >= 0 ~ UCI, sum_diff < 0 ~ -UCI))

e_type1_prop_diff_ethnicity_vis <-
e_type1_prop_diff_ethnicity %>% 
  ggplot(aes(y = reorder(demographic_var, diff_prop), x = diff_prop)) +
  geom_col(fill = "#f9bf07", colour = "#636363") +
  geom_errorbar(aes(xmin=LCI, xmax=UCI), width = 0.25, colour = "#636363") +
  labs(x = "Proportional change", 
       y = "Ethnicity",
       title = "Proportional changes do not appear to be driven by ethnicity",
       subtitle = "Proportional change in ED attendance count for type 1 diabetes between 2019-20 by ethnicity",
       caption = "Proportional change = change between 2019-20 / total attendance count for 2019")

# Serverity 
e_type1_cum_diff_severity <-
  e_get_attendance_diff_type1(Severity) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_diff)) %>% 
  pivot_longer(cols = c(-week_number, -demographic_var),
               names_to = "trend", 
               values_to = "count") %>% 
  filter(trend == "cum_def") %>% 
  filter(week_number < 53) %>% 
  drop_na(demographic_var) %>% 
  ungroup() 

e_type1_cum_diff_severity_vis <-
  e_type1_cum_diff_severity %>%
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  filter(demographic_var != "100+") %>% 
  ggplot(aes(week_number, count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_SU(palette = "main") +
  theme(legend.position = "none") +
  labs(title = "...", 
       subtitle = "Cumulative change in weekly attendance count for type 1 diabetes between 2019 and 2020, by attendance severity",
       caption = "Attendance difference = 2020 count - 2019 count",
       x = "Week number",
       y = "Cumulative attendance difference")

# Severity - proportional difference between 2019-2020
e_type1_prop_diff_severity <-
  e_get_attendance_diff_type1(Severity) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_diff = sum(PC_diff, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(diff_prop = sum_diff/sum_2019*100) %>% 
  mutate(sum_diff_adj = case_when(sum_diff >= 0 ~ sum_diff,
                                  sum_diff < 0 ~ -sum_diff )) %>% 
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_diff >= 0 ~ LCI, sum_diff < 0 ~ -LCI),
         UCI = case_when(sum_diff >= 0 ~ UCI, sum_diff < 0 ~ -UCI)) 

e_type1_prop_diff_severity_vis <-
  e_type1_prop_diff_severity %>% 
  filter(demographic_var != "NA") %>% 
  ggplot(aes(y = demographic_var, x = diff_prop)) +
  geom_col(fill = "#f9bf07", colour = "#636363") +
  geom_errorbar(aes(xmin=LCI, xmax=UCI), width = 0.25, colour = "#636363") +
  labs(x = "Proportional change", 
       y = "Attendance severity",
       title = "The proportional reduction in attendances is largest in 4-12 ED spells",
       subtitle = "Proportional change in ED attendance count for type 1 diabetes between 2019-20 by attendance severity",
       caption = "Proportional change = change between 2019-20 / total attendance count for 2019")


## Type 2: Changing rates of attendances  ####
g_type2_weekly_count <-
g_diabetes_demographic_index %>% 
  filter(Description == "Diabetes mellitus type 2 (disorder)") %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  filter(Admission_week > "2019-01-01" &
           Admission_week < "2020-12-31") 

g_type2_weekly_count_vis <-
g_type2_weekly_count %>%
  ggplot(aes(x = Admission_week, y = Activity)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 180, label = str_wrap("Lockdown", 10) ,size = 2.5, angle = 90) +
  annotate("text", x = as.Date("2020-08-24"), y = 180, label = str_wrap("Recovery", 10) ,size = 2.5, angle = 90) +
  annotate("text", x = as.Date("2020-11-24"), y = 180, label = str_wrap("Lockdown", 10) ,size = 2.5, angle = 90) +
  geom_smooth(method = "loess", span = 0.3, colour = "#f9bf07") +
  labs(x = "Date", y = "Count",
       title = "ED attendances for Type 2 diabetes have returned to pre-pandemic levels",
       subtitle = "Weekly count of ED attenance for Type 2 Diabetes, National 2019-20")

# Break this down by demographic
# Region
g_type2_weekly_count_region <-
g_diabetes_demographic_index %>% 
  filter(Description == "Diabetes mellitus type 2 (disorder)") %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, nhser20nm) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  filter(Admission_week > "2019-01-01" &
           Admission_week < "2020-12-31") %>% 
  drop_na(nhser20nm) %>% 
  ungroup() 

g_type2_weekly_count_region_vis <-
g_type2_weekly_count_region %>% 
  ggplot(aes(x = Admission_week, y = Activity, colour = nhser20nm)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("Recovery", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  geom_smooth(method = "loess", span = 0.3, se = TRUE) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y = "Count", color = "NHSE Region",
       title = "Attendances in the South East have continued to rise after the first lockdown",
       subtitle = "Weekly count of ED attenance for Type 2 Diabetes, by Region, National 2019-20")

# Age
g_type2_weekly_count_age <-
g_diabetes_demographic_index %>% 
  filter(Description == "Diabetes mellitus type 2 (disorder)") %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, Age_range) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  filter(Admission_week > "2019-01-01" &
           Admission_week < "2020-12-31") %>% 
  drop_na(Age_range) 

g_type2_weekly_count_age_vis <-
g_type2_weekly_count_age %>%
  filter(Age_range != "100+") %>% 
  ggplot(aes(x = Admission_week, y = Activity, colour = Age_range, group = Age_range)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("Recovery", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y = "Count", color = "Age range",
       title = "Attendances in 40-80  year olds were particularly impacted by lockdowns",
       subtitle = "Weekly count of ED attenance for Type 2 Diabetes, by Age range, National 2019-20")

# Deprivation 
g_type2_weekly_count_deprivation <-
g_diabetes_demographic_index %>% 
  filter(Description == "Diabetes mellitus type 2 (disorder)") %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, IMD_Quintile) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  filter(Admission_week > "2019-01-01" &
           Admission_week < "2020-12-31") %>% 
  drop_na(IMD_Quintile) %>% 
  mutate(IMD_Quintile = factor(IMD_Quintile, levels = c(1,2,3,4,5))) 

g_type2_weekly_count_deprivation_vis <-
g_type2_weekly_count_deprivation %>% 
  ggplot(aes(x = Admission_week, y = Activity, colour = IMD_Quintile, group = IMD_Quintile)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("Recovery", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y = "Count", color = "IMD Quintile",
       title = "ED attendances were more frequent in deprived groups and more impacted by the lockdowns",
       subtitle = "Weekly count of ED attenance for Type 2 Diabetes, by IMD Quintile, National 2019-20")

# Broad ethnicity
g_type2_weekly_count_ethnicity_broad <-
g_diabetes_demographic_index %>% 
  filter(Description == "Diabetes mellitus type 2 (disorder)") %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, Ethnicity_broad) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  filter(Admission_week > "2019-01-01" &
           Admission_week < "2020-12-31") %>% 
  drop_na(Ethnicity_broad) 

g_type2_weekly_count_ethnicity_broad_vis <-
g_type2_weekly_count_ethnicity_broad %>%  
  ggplot(aes(x = Admission_week, y = Activity, colour = Ethnicity_broad, group = Ethnicity_broad)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("Recovery", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y = "Count", color = "Broad ethnicity",
       title = "...",
       subtitle = "Weekly count of ED attenance for Type 2 Diabetes, by broad ethnicity, National 2019-20")

# Broad ethnicity - facet 
g_type2_weekly_count_ethnicity_broad_facet <-
  g_type2_weekly_count_ethnicity_broad %>%  
  ggplot(aes(x = Admission_week, y = Activity, colour = Ethnicity_broad, group = Ethnicity_broad)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  #annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("L", 10) ,size = 3) +
  #annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("R", 10) ,size = 3) +
  #annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("L", 10) ,size = 3) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU(palette = "main") +
  facet_wrap(~Ethnicity_broad, scales = "free") +
  theme(legend.position = "none",
        strip.text = element_text(face = "bold"),
        axis.text.x = element_text(angle = 90, size = 8)) +
  labs(x = "Date", y = "Count", color = "Broad ethnicity",
       title = "Asian, Black and White patients have similar trends in ED attendance",
       subtitle = "Weekly count of ED attenance for Type 2 Diabetes, by broad ethnicity, National 2019-20"
       #caption = "L: Lockdown, R: Recovery"
       )

# Severity
g_type2_weekly_count_severity <-
g_diabetes_demographic_index %>% 
  filter(Description == "Diabetes mellitus type 2 (disorder)") %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, Severity) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  filter(Admission_week > "2019-01-01" & Admission_week < "2020-12-31") %>% 
  filter(Severity != "NA") 

g_type2_weekly_count_severity_vis <-
g_type2_weekly_count_severity %>%  
  ggplot(aes(x = Admission_week, y = Activity, colour = Severity, group = Severity)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("Recovery", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y = "Count", color = "Severity",
       title = "Attendances that are treated in and disharged from ED are increasing post-pandemic",
       subtitle = "Weekly count of ED attenance for Type 2 Diabetes, by attendance severity, National 2019-20")

## Type 2: Proportional change in attendances ####
e_get_attendance_diff_type2 <- function(demographic_var) {
  
  g_diabetes_demographic_index <- 
    g_diabetes_demographic_index %>%
    mutate(demographic_var = {{demographic_var}})
  
  sub_data <-
    g_diabetes_demographic_index %>% 
    filter(Description == "Diabetes mellitus type 2 (disorder)") %>% 
    mutate(year = year(Arrival_Date),
           month = months(Arrival_Date), 
           week_number = isoweek(Arrival_Date)) %>% 
    group_by(year, week_number, demographic_var) %>% 
    summarise(weekly_admissions = sum(Admission_count)) %>% 
    ungroup()
  
  sub_data_wide <-
    sub_data %>% 
    filter(year == 2020) %>% 
    rename(n_2020 = weekly_admissions) %>% 
    select(-year) %>% 
    left_join(sub_data %>% 
                filter(year == 2018) %>% 
                select(-year) %>% 
                rename(n_2018 = weekly_admissions), by = c("week_number", 'demographic_var'), keep = FALSE) %>% 
    left_join(sub_data %>% 
                filter(year == 2019) %>% 
                select(-year) %>% 
                rename(n_2019 = weekly_admissions), by = c("week_number", 'demographic_var'), keep = FALSE) %>% 
    group_by(week_number, demographic_var) %>% 
    #mutate(Avg1819 =  round(mean(c(n_2018, n_2019), na.rm=T))) %>% 
    mutate(diff = n_2020 - n_2019) %>% 
    mutate(PC_diff = case_when(
      week_number < 13 ~ as.numeric(0),
      week_number >= 13 ~ as.numeric(n_2020 - n_2019))) %>%  # Additional variable to start deficit from lockdown start
    ungroup() 
  
  sub_data_wide
}

# Region
e_type2_cum_diff_region <-
  e_get_attendance_diff_type2(nhser20nm) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_diff)) %>% 
  pivot_longer(cols = c(-week_number, -demographic_var),
               names_to = "trend", 
               values_to = "count") %>% 
  filter(trend == "cum_def") %>% 
  filter(week_number < 53) %>% 
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  drop_na(demographic_var) 

e_type2_cum_diff_region_vis <-
e_type2_cum_diff_region %>%
  ggplot(aes(x = week_number, y = count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_SU(palette = "main") +
  theme(legend.position = "none") +
  labs(title = "Sustained reductions in attendances are seen in the Midlands and London", 
       subtitle = "Cumulative change in weekly attendance count for type 2 diabetes between 2019 and 2020, by NHSE region",
       caption = "Attendance difference = 2020 count - 2019 count",
       x = "Week number",
       y = "Cumulative attendance difference")

# Region - proportional difference between 2019-2020
e_type2_prop_diff_region <-
  e_get_attendance_diff_type2(nhser20nm) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_diff = sum(PC_diff, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(diff_prop = sum_diff/sum_2019*100) %>% 
  mutate(sum_diff_adj = case_when(sum_diff >= 0 ~ sum_diff,
                                  sum_diff < 0 ~ -sum_diff )) %>% 
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_diff >= 0 ~ LCI, sum_diff < 0 ~ -LCI),
         UCI = case_when(sum_diff >= 0 ~ UCI, sum_diff < 0 ~ -UCI)) # Return CI's to negative where the def was negative

e_type2_prop_diff_region_vis <-
e_type2_prop_diff_region %>% 
  ggplot(aes(y = reorder(demographic_var, diff_prop), x = diff_prop)) +
  geom_col(fill = "#f9bf07", colour = "#636363") +
  geom_errorbar(aes(xmin=LCI, xmax=UCI), width = 0.25, colour = "#636363") +
  labs(x = "Proportional change", 
       y = "NHSE Region",
       title = "The South of England saw increases in ED attendances",
       subtitle = "Proportional change in ED attendance count for type 2 diabetes between 2019-20 by NHSE Region",
       caption = "Proportional change = change between 2019-20 / total attendance count for 2019")

# Age
e_type2_cum_diff_age_range <-
  e_get_attendance_diff_type2(Age_range) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_diff)) %>% 
  pivot_longer(cols = c(-week_number, -demographic_var),
               names_to = "trend", 
               values_to = "count") %>% 
  filter(trend == "cum_def") %>% 
  filter(week_number < 53) %>% 
  drop_na(demographic_var) %>% 
  ungroup()

e_type2_cum_diff_age_range_vis <-
e_type2_cum_diff_age_range %>%
  filter(demographic_var != "100+") %>%
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  ggplot(aes(week_number, count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_SU(palette = "main") +
  theme(legend.position = "none") +
  labs(title = "ED attendances for elderly patients were more disrupted by the pandemic than 20-40 year olds", 
       subtitle = "Cumulative change in weekly attendance count for type 2 diabetes between 2019 and 2020, by Age range",
       caption = "Attendance difference = 2020 count - 2019 count",
       x = "Week number",
       y = "Cumulative attendance difference")

# Age range - proportional difference between 2019-2020
e_type2_prop_diff_age <-
  e_get_attendance_diff_type2(Age_range) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_diff = sum(PC_diff, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(diff_prop = sum_diff/sum_2019*100) %>% 
  mutate(sum_diff_adj = case_when(sum_diff >= 0 ~ sum_diff,
                                  sum_diff < 0 ~ -sum_diff )) %>% 
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_diff >= 0 ~ LCI, sum_diff < 0 ~ -LCI),
         UCI = case_when(sum_diff >= 0 ~ UCI, sum_diff < 0 ~ -UCI))  # Return CI's to negative where the def was negative

e_type2_prop_diff_age_vis <-
e_type2_prop_diff_age %>% 
  filter(demographic_var != "100+") %>% 
  ggplot(aes(y = demographic_var, x = diff_prop)) +
  geom_col(fill = "#f9bf07", colour = "#636363") +
  geom_errorbar(aes(xmin=LCI, xmax=UCI), width = 0.25, colour = "#636363") +
  labs(x = "Proportional change", 
       y = "Age range",
       title = "1 in 5 attendances for 80+ year olds were avoided due to the pandemic",
       subtitle = "Proportional change in ED attendance count for type 2 diabetes between 2019-20 by age range",
       caption = "Proportional change = change between 2019-20 / total attendance count for 2019")

# Deprivation
e_type2_cum_diff_deprivation <-
  e_get_attendance_diff_type2(IMD_Quintile) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_diff)) %>% 
  pivot_longer(cols = c(-week_number, -demographic_var),
               names_to = "trend", 
               values_to = "count") %>% 
  filter(trend == "cum_def") %>% 
  filter(week_number < 53) %>% 
  drop_na(demographic_var) %>% 
  ungroup() %>% 
  mutate(demographic_var = factor(demographic_var, levels = c(1,2,3,4,5)))

e_type2_cum_diff_deprivation_vis <-
e_type2_cum_diff_deprivation %>%
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  filter(demographic_var != "100+") %>% 
  ggplot(aes(week_number, count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_SU(palette = "main") +
  theme(legend.position = "none") +
  labs(title = "The cumulative reduction in ED attendances increases with deprivation", 
       subtitle = "Cumulative change in weekly attendance count for type 2 diabetes between 2019 and 2020, by IMD Quintile ",
       caption = "Attendance difference = 2020 count - 2019 count",
       x = "Week number",
       y = "Cumulative attendance difference")

# Deprivation - proportional difference between 2019-2020
e_type2_prop_diff_deprivation <-
  e_get_attendance_diff_type2(IMD_Quintile) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_diff = sum(PC_diff, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(diff_prop = sum_diff/sum_2019*100) %>% 
  mutate(sum_diff_adj = case_when(sum_diff >= 0 ~ sum_diff,
                                  sum_diff < 0 ~ -sum_diff )) %>% 
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_diff >= 0 ~ LCI, sum_diff < 0 ~ -LCI),
         UCI = case_when(sum_diff >= 0 ~ UCI, sum_diff < 0 ~ -UCI)) %>%   # Return CI's to negative where the def was negative
  mutate(demographic_var = factor(demographic_var, levels = c(1,2,3,4,5)))

e_type2_prop_diff_deprivation_vis <-
e_type2_prop_diff_deprivation %>% 
  ggplot(aes(y = demographic_var, x = diff_prop)) +
  geom_col(fill = "#f9bf07", colour = "#636363") +
  geom_errorbar(aes(xmin=LCI, xmax=UCI), width = 0.25, colour = "#636363") +
  labs(x = "Proportional change", 
       y = "IMD Quintile",
       title = "Change in attendance varied across deprivation quintiles",
       subtitle = "Proportional change in ED attendance count for type 2 diabetes between 2019-20 by IMD Quintile",
       caption = "Proportional change = change between 2019-20 / total attendance count for 2019")

# Ethnicity
# Ethnic_Category_Desc
e_type2_cum_diff_ethnicity <-
  e_get_attendance_diff_type2(Ethnicity_broad) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_diff)) %>% 
  pivot_longer(cols = c(-week_number, -demographic_var),
               names_to = "trend", 
               values_to = "count") %>% 
  filter(trend == "cum_def") %>% 
  filter(week_number < 53) %>% 
  drop_na(demographic_var) %>% 
  ungroup() 

e_type2_cum_diff_ethnicity_vis <-
e_type2_cum_diff_ethnicity %>%
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  filter(demographic_var != "100+") %>% 
  ggplot(aes(week_number, count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_SU(palette = "main") +
  theme(legend.position = "none") +
  labs(title = "An increase in ethnicity recored as 'Unknown' is seen during the second lockdown", 
       subtitle = "Change in weekly attendance count for type 2 diabetes between 2019 and 2020, by broad ethnicity",
       caption = "Attendance difference = 2020 count - 2019 count",
       x = "Week number",
       y = "Cumulative attendance difference")

# Ethnicity - proportional difference between 2019-2020
e_type2_prop_diff_ethnicity <-
  e_get_attendance_diff_type2(Ethnic_Category_Desc) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_diff = sum(PC_diff, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(diff_prop = sum_diff/sum_2019*100) %>% 
  mutate(sum_diff_adj = case_when(sum_diff >= 0 ~ sum_diff,
                                  sum_diff < 0 ~ -sum_diff )) %>% 
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_diff >= 0 ~ LCI, sum_diff < 0 ~ -LCI),
         UCI = case_when(sum_diff >= 0 ~ UCI, sum_diff < 0 ~ -UCI))

e_type2_prop_diff_ethnicity_vis <-
e_type2_prop_diff_ethnicity %>% 
  ggplot(aes(y = reorder(demographic_var, diff_prop), x = diff_prop)) +
  geom_col(fill = "#f9bf07", colour = "#636363") +
  geom_errorbar(aes(xmin=LCI, xmax=UCI), width = 0.25, colour = "#636363") +
  labs(x = "Proportional change", 
       y = "Ethnicity",
       title = "Attendances in Indian and Pakistani patients were more disrupted than in White British",
       subtitle = "Proportional change in ED attendance count for type 2 diabetes between 2019-20 by ethnicity",
       caption = "Proportional change = change between 2019-20 / total attendance count for 2019")

# Severity 
e_type2_cum_diff_severity <-
  e_get_attendance_diff_type2(Severity) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_diff)) %>% 
  pivot_longer(cols = c(-week_number, -demographic_var),
               names_to = "trend", 
               values_to = "count") %>% 
  filter(trend == "cum_def") %>% 
  filter(week_number < 53) %>% 
  drop_na(demographic_var) %>% 
  ungroup() 

e_type2_cum_diff_severity_vis <-
  e_type2_cum_diff_severity %>%
  filter(demographic_var != "NA") %>% 
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  filter(demographic_var != "100+") %>% 
  ggplot(aes(week_number, count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_SU(palette = "main") +
  theme(legend.position = "none") +
  labs(title = "The pandemic has seen a rise in type 2 diabetics discharged from ED in less than 4hrs", 
       subtitle = "Cumulative change in weekly attendance count for type 2 diabetes between 2019 and 2020, by attendance severity",
       caption = "Attendance difference = 2020 count - 2019 count",
       x = "Week number",
       y = "Cumulative attendance difference")

# Severity - proportional difference between 2019-2020
e_type2_prop_diff_severity <-
  e_get_attendance_diff_type2(Severity) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_diff = sum(PC_diff, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(diff_prop = sum_diff/sum_2019*100) %>% 
  mutate(sum_diff_adj = case_when(sum_diff >= 0 ~ sum_diff,
                                  sum_diff < 0 ~ -sum_diff )) %>% 
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_diff >= 0 ~ LCI, sum_diff < 0 ~ -LCI),
         UCI = case_when(sum_diff >= 0 ~ UCI, sum_diff < 0 ~ -UCI)) 

e_type2_prop_diff_severity_vis <-
  e_type2_prop_diff_severity %>% 
  filter(demographic_var != "NA") %>% 
  ggplot(aes(y = demographic_var, x = diff_prop)) +
  geom_col(fill = "#f9bf07", colour = "#636363") +
  geom_errorbar(aes(xmin=LCI, xmax=UCI), width = 0.25, colour = "#636363") +
  labs(x = "Proportional change", 
       y = "Attendance severity",
       title = "Attedances treated in 4-12hrs then discharged from ED have greatly reduced",
       subtitle = "Proportional change in ED attendance count for type 2 diabetes between 2019-20 by attendance severity",
       caption = "Proportional change = change between 2019-20 / total attendance count for 2019")


## Changing rates of DKA ####
# Identification of diabetes type in DKA attendances - Using secondary diagnosis codes in EC record
g_diabetes_demographic_index %>% 
  filter(Description == "Diabetic ketoacidosis") %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, diabetes_type_flag) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  #filter(Admission_week > "2019-01-01") %>% 
  
  ggplot(aes(x = Admission_week, y = Activity, colour = diabetes_type_flag)) +
  geom_smooth(method = "loess", span = 0.3)

g_diabetes_demographic_index %>% 
  filter(Description == "Diabetic ketoacidosis") %>% 
  group_by(diabetes_type_flag) %>% 
  summarise(n = n())

# # A tibble: 3 x 2
# diabetes_type_flag     n
# <chr>              <int>
# 1 Type_1               552
# 2 Type_2                74
# 3 Unknown            50274

# Time series for DKA attendances
# Problematic time series for DKA - Unsuitable to compare to previous years
g_DKA_weekly_count <-
  g_diabetes_demographic_index %>% 
  filter(Description == "Diabetic ketoacidosis") %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  filter(Admission_week < "2020-12-31") 

g_DKA_weekly_count_vis <-
  g_DKA_weekly_count %>%
  ggplot(aes(x = Admission_week, y = Activity)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 225, label = str_wrap("Lockdown", 10) ,size = 2.5, angle = 90) +
  annotate("text", x = as.Date("2020-08-24"), y = 225, label = str_wrap("Recovery", 10) ,size = 2.5, angle = 90) +
  annotate("text", x = as.Date("2020-11-24"), y = 225, label = str_wrap("Lockdown", 10) ,size = 2.5, angle = 90) +
  geom_smooth(method = "loess", span = 0.3, colour = "#f9bf07") +
  labs(x = "Date", y = "Count",
       title = "Data quality and variability in ED attendances are problematic",
       subtitle = "Weekly count of ED attenance for DKA, National 2019-20",
       caption = "Note: Type 1 & 2 diabetics included")


## DKA - Inpatient admissions ####
g_diabetes_ICD10 <-
read_csv("Diabetes_ICD10_codes.csv") %>% 
  clean_names() %>% 
  select(full_icd10_code, title)

g_ip_diabetes_diag <-
a.ip_diabetes %>% 
  left_join(g_diabetes_ICD10, by = c("Der_Primary_Diagnosis_Code" = "full_icd10_code")) %>% 
  left_join(select(c_lsoa_imd, LSOA_Code, IMD_Decile), by = c("Der_Postcode_LSOA_2011_Code" = "LSOA_Code")) %>%
  mutate(IMD_Quintile = case_when(IMD_Decile %in% c(1,2) ~ 1,
                                  IMD_Decile %in% c(3,4) ~ 2,
                                  IMD_Decile %in% c(5,6) ~ 3,
                                  IMD_Decile %in% c(7,8) ~ 4,
                                  IMD_Decile %in% c(9,10) ~ 5,
                                  TRUE ~ 99)) %>% 
  mutate(
    Ethnic_Group = case_when(Ethnic_Group %in% c("99", "NA") ~ Ethnic_Group,
                             TRUE ~ substr(Ethnic_Group,1,1)
                             )) %>% # Shorten Ethnic group to first character to clean data (except when coded as 99 or NA)
  mutate(
    Ethnic_Group = case_when(is.na(Ethnic_Group) ~ "99",
                             TRUE ~ Ethnic_Group)) %>% # Replace NA's with "NA" to left_join to "Not Known"
  left_join(c_ethnicity_lookup, by = c("Ethnic_Group" = "Ethnic_Category"))


# DKA in all patients
g_DKA_ip_weekly_count <-
  g_ip_diabetes_diag %>% 
  filter(str_detect(title, "ketoacidosis") & 
           substr(Admission_Method,1,1) == "2") %>% 
  mutate(Admission_week = floor_date(as.Date(Admission_Date), unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week) %>% 
  summarise(Activity = n_distinct(APCS_Ident)) %>% 
  #filter(Admission_week > "2019-01-01") %>%
  filter(Admission_week < "2020-12-31")   

g_DKA_ip_weekly_count_vis <-
  g_DKA_ip_weekly_count %>%
  ggplot(aes(x = Admission_week, y = Activity)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 500, label = str_wrap("Lockdown", 10) ,size = 2.5, angle = 90) +
  annotate("text", x = as.Date("2020-08-24"), y = 500, label = str_wrap("Recovery", 10) ,size = 2.5, angle = 90) +
  annotate("text", x = as.Date("2020-11-24"), y = 500, label = str_wrap("Lockdown", 10) ,size = 2.5, angle = 90) +
  geom_point(size = 2, alpha = 0.2, colour = "#2c2825") +
  geom_smooth(method = "loess", span = 0.3, colour = "#f9bf07") +
  labs(x = "Date", y = "Count",
       title = "The seasonal nature in DKA admissions suggest behavioural influences",
       subtitle = "Weekly count of inpatient admissions for diabetic ketoacidosis (DKA), National 2019-20",
       caption = "Note: Type 1 & 2 diabetics included")

# DKA in Type 1 and Type 2 diabetes - separately
g_diabetes_ICD10 %>% 
  filter(str_detect(title, "Insulin-dependent diabetes")) %>% 
  select(full_icd10_code)

g_icd10_type_1 <- c("E10","E100","E101","E102","E103","E104","E105","E106","E107","E108","E109")

g_diabetes_ICD10 %>% 
  filter(str_detect(title, "Non-insulin-dependent diabetes mellitus")) %>% 
  select(full_icd10_code)

g_icd10_type_2 <- c("E11","E110","E111","E112","E113","E114","E115","E116","E117","E118","E119")

# Derive diabetes type 
g_ip_diabetes_diag_DKA <-
  g_ip_diabetes_diag %>% 
  filter(str_detect(title, "ketoacidosis") & 
           substr(Admission_Method,1,1) == "2") %>% 
  mutate(diabetes_type = case_when(
    str_detect(Der_Diagnosis_All, paste(g_icd10_type_1, collapse = "|")) ~ "Type_1",
    str_detect(Der_Diagnosis_All, paste(g_icd10_type_2, collapse = "|")) ~ "Type_2",
    TRUE ~ "Unknown")) %>% 
  mutate(Admission_Date = as.Date(Admission_Date))

# Seasonal spikes in DKA? 
g_DKA_ip_weekly_count_by_type <-
  g_ip_diabetes_diag_DKA %>%  
  mutate(Admission_week = floor_date(as.Date(Admission_Date), unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, diabetes_type) %>% 
  summarise(Activity = n_distinct(APCS_Ident)) %>% 
  #filter(Admission_week > "2019-01-01") %>%
  filter(Admission_week < "2020-12-31")   

g_DKA_ip_weekly_count_by_type_vis <-
  g_DKA_ip_weekly_count_by_type %>%
  ggplot(aes(x = Admission_week, y = Activity, colour = diabetes_type, group = diabetes_type)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 200, label = str_wrap("Lockdown", 10) ,size = 2.5, angle = 90) +
  annotate("text", x = as.Date("2020-08-24"), y = 200, label = str_wrap("Recovery", 10) ,size = 2.5, angle = 90) +
  annotate("text", x = as.Date("2020-11-24"), y = 200, label = str_wrap("Lockdown", 10) ,size = 2.5, angle = 90) +
  geom_point(size = 2, alpha = 0.2) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y = "Count", colour = "Diabetes Type",
       title = "Seasonality features in DKA admissions for type 1 & 2 diabetes",
       subtitle = "Weekly count of inpatient admissions for diabetic ketoacidosis (DKA), National 2019-20",
       caption = "Note: 'Unknown' includes Malnutrition-related, Unspecified and Other diabetes")
  
# Trends in DKA by region and demographic

# Region 
g_DKA_IP_weekly_count_region <-
  g_ip_diabetes_diag_DKA %>% 
  mutate(Admission_week = floor_date(Admission_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, diabetes_type,  nhser20nm) %>% 
  summarise(Activity = n_distinct(APCS_Ident)) %>% 
  #filter(Admission_week > "2019-01-01") %>% 
  filter(Admission_week < "2020-12-31") %>% 
  drop_na(nhser20nm) %>% 
  ungroup() 

g_DKA_IP_weekly_count_region_vis <-
  g_DKA_IP_weekly_count_region %>% 
  filter(diabetes_type != "Unknown") %>% 
  ggplot(aes(x = Admission_week, y = Activity, colour = diabetes_type, group = diabetes_type)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("L", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("R", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("L", 10) ,size = 2.5) +
  geom_smooth(method = "loess", span = 0.3) +
  facet_wrap(~nhser20nm) +
  theme(strip.text = element_text(face = "bold")) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y = "Count", color = "NHSE Region",
       title = "No interesting finding ... ",
       subtitle = "Weekly count of IP admission for DKA, by Region, National 2019-20",
       caption = "L: Lockdown, R: Recovery")


# Age 
g_DKA_IP_weekly_count_age <-
  g_ip_diabetes_diag_DKA %>% 
  mutate(Admission_week = floor_date(Admission_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, diabetes_type,  Age_range) %>% 
  summarise(Activity = n_distinct(APCS_Ident)) %>% 
  #filter(Admission_week > "2019-01-01") %>% 
  filter(Admission_week < "2020-12-31") %>% 
  drop_na(Age_range) %>% 
  ungroup()

g_DKA_IP_weekly_count_age_vis <-
  g_DKA_IP_weekly_count_age %>% 
  filter(diabetes_type != "Unknown") %>% 
  filter(Age_range != "100+") %>%
  #filter(Age_range %in% c("0-19", "20-39", "40-59", "60-79", "80-99")) %>% 
  
  ggplot(aes(x = Admission_week, y = Activity, colour = Age_range)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("L", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("R", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("L", 10) ,size = 2.5) +
  #geom_point(size = 1.5, alpha = 0.75) +
  geom_smooth(method = "loess", span = 0.3) +
  facet_wrap(~diabetes_type, scales = "free") +
  theme(strip.text = element_text(face = "bold")) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y = "Count", color = "Age range",
       title = "DKA is more common in under 40 type 1 and 40-80 year old type 2 diabetics ",
       subtitle = "Weekly count of IP admission for DKA, by Age range and diabetes type, National 2019-20",
       caption = "L: Lockdown, R: Recovery")


# Deprivation 
g_DKA_IP_weekly_count_deprivation  <-
  g_ip_diabetes_diag_DKA %>% 
  mutate(Admission_week = floor_date(Admission_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, diabetes_type,  IMD_Quintile) %>% 
  summarise(Activity = n_distinct(APCS_Ident)) %>% 
  #filter(Admission_week > "2019-01-01") %>% 
  filter(Admission_week < "2020-12-31") %>% 
  drop_na(IMD_Quintile) %>% 
  ungroup() %>% 
  mutate(IMD_Quintile = factor(IMD_Quintile, levels = c(1,2,3,4,5)))

g_DKA_IP_weekly_count_deprivation_vis <-
  g_DKA_IP_weekly_count_deprivation %>%  
  filter(diabetes_type != "Unknown",
         IMD_Quintile != "NA") %>% 
  
  ggplot(aes(x = Admission_week, y = Activity, colour = IMD_Quintile, group = IMD_Quintile)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("L", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("R", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("L", 10) ,size = 2.5) +
  #geom_point(size = 1.5, alpha = 0.75) +
  geom_smooth(method = "loess", span = 0.3) +
  facet_wrap(~diabetes_type, scales = "free") +
  theme(strip.text = element_text(face = "bold")) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y = "Count", color = "IMD Quintile",
       title = "Deprivation gradient seen in attendances for DKA in both types of diabetes",
       subtitle = "Weekly count of IP admission for DKA, by IMD Quintile and diabetes type, National 2019-20",
       caption = "L: Lockdown, R: Recovery")

# Ethnicity 
g_DKA_IP_weekly_count_ethnicity  <-
  g_ip_diabetes_diag_DKA %>% 
  mutate(Admission_week = floor_date(Admission_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, diabetes_type,  Ethnicity_broad) %>% 
  summarise(Activity = n_distinct(APCS_Ident)) %>% 
  #filter(Admission_week > "2019-01-01") %>% 
  filter(Admission_week < "2020-12-31") %>% 
  drop_na(Ethnicity_broad) %>% 
  ungroup() 

g_DKA_IP_weekly_count_ethnicity_vis <-
  g_DKA_IP_weekly_count_ethnicity %>%  
  filter(diabetes_type != "Unknown",
         Ethnicity_broad == "White") %>% 
  
  ggplot(aes(x = Admission_week, y = Activity, colour = Ethnicity_broad, group = Ethnicity_broad)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("L", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("R", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("L", 10) ,size = 2.5) +
  #geom_point(size = 1.5, alpha = 0.75) +
  geom_smooth(method = "loess", span = 0.3) +
  facet_wrap(~diabetes_type, scales = "free") +
  theme(strip.text = element_text(face = "bold")) +
  scale_color_manual(values = c("#5881c1")) +
  labs(x = "Date", y = "Count", color = "Broad ethnicity",
       title = "Seasonality trends in the White population are similar acrss diabetes types",
       subtitle = "Weekly count of IP admission for DKA, by ethnicity and diabetes type, National 2019-20")

# Excluding white group
g_DKA_IP_weekly_count_ethnicity_nonWhite_vis <-
g_DKA_IP_weekly_count_ethnicity %>%  
  filter(diabetes_type != "Unknown",
         Ethnicity_broad != "White") %>% 
  
  ggplot(aes(x = Admission_week, y = Activity, colour = Ethnicity_broad, group = Ethnicity_broad)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 0, label = str_wrap("L", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-08-24"), y = 0, label = str_wrap("R", 10) ,size = 2.5) +
  annotate("text", x = as.Date("2020-11-30"), y = 0, label = str_wrap("L", 10) ,size = 2.5) +
  #geom_point(size = 1.5, alpha = 0.75) +
  geom_smooth(method = "loess", span = 0.3) +
  facet_wrap(~diabetes_type, scales = "free") +
  theme(strip.text = element_text(face = "bold")) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y = "Count", color = "",
       caption = "L: Lockdown, R: Recovery")


## Proportional changes in DKA admissions ####
e_get_attendance_diff_DKA <- function(demographic_var) {
  
  g_ip_diabetes_diag_DKA <- 
    g_ip_diabetes_diag_DKA %>%
    mutate(demographic_var = {{demographic_var}})
  
  sub_data <-
    g_ip_diabetes_diag_DKA %>%  
    mutate(year = year(Admission_Date),
           month = months(Admission_Date), 
           week_number = isoweek(Admission_Date)) %>% 
    group_by(year, week_number, demographic_var) %>% 
    summarise(weekly_admissions = n_distinct(APCS_Ident)) %>% 
    ungroup()
  
  sub_data_wide <-
    sub_data %>% 
    filter(year == 2020) %>% 
    rename(n_2020 = weekly_admissions) %>% 
    select(-year) %>% 
    left_join(sub_data %>% 
                filter(year == 2018) %>% 
                select(-year) %>% 
                rename(n_2018 = weekly_admissions), by = c("week_number", 'demographic_var'), keep = FALSE) %>% 
    left_join(sub_data %>% 
                filter(year == 2019) %>% 
                select(-year) %>% 
                rename(n_2019 = weekly_admissions), by = c("week_number", 'demographic_var'), keep = FALSE) %>% 
    group_by(week_number, demographic_var) %>% 
    #mutate(Avg1819 =  round(mean(c(n_2018, n_2019), na.rm=T))) %>% 
    mutate(diff = n_2020 - n_2019) %>% 
    mutate(PC_diff = case_when(
      week_number < 13 ~ as.numeric(0),
      week_number >= 13 ~ as.numeric(n_2020 - n_2019))) %>%  # Additional variable to start deficit from lockdown start
    ungroup() 
  
  sub_data_wide
}

# Region
e_DKA_cum_diff_region <-
  e_get_attendance_diff_DKA(nhser20nm) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_diff)) %>% 
  pivot_longer(cols = c(-week_number, -demographic_var),
               names_to = "trend", 
               values_to = "count") %>% 
  filter(trend == "cum_def") %>% 
  filter(week_number < 53) %>% 
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  drop_na(demographic_var) 

e_DKA_cum_diff_region_vis <-
  e_DKA_cum_diff_region %>%
  ggplot(aes(x = week_number, y = count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_SU(palette = "main") +
  theme(legend.position = "none") +
  labs(title = "East of England saw sharp reductions where others plateaued", 
       subtitle = "Cumulative change in weekly admission count for DKA between 2019 and 2020, by NHSE region",
       caption = "Admission difference = 2020 count - 2019 count",
       x = "Week number",
       y = "Cumulative admission difference")

# Region - proportional difference between 2019-2020
e_DKA_prop_diff_region <-
  e_get_attendance_diff_DKA(nhser20nm) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_diff = sum(PC_diff, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(diff_prop = sum_diff/sum_2019*100) %>% 
  mutate(sum_diff_adj = case_when(sum_diff >= 0 ~ sum_diff,
                                  sum_diff < 0 ~ -sum_diff )) %>% 
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_diff >= 0 ~ LCI, sum_diff < 0 ~ -LCI),
         UCI = case_when(sum_diff >= 0 ~ UCI, sum_diff < 0 ~ -UCI)) # Return CI's to negative where the def was negative

e_DKA_prop_diff_region_vis <-
  e_DKA_prop_diff_region %>% 
  ggplot(aes(y = reorder(demographic_var, diff_prop), x = diff_prop)) +
  geom_col(fill = "#f9bf07", colour = "#636363") +
  geom_errorbar(aes(xmin=LCI, xmax=UCI), width = 0.25, colour = "#636363") +
  labs(x = "Proportional change", 
       y = "NHSE Region",
       title = "East of England demostrates large absolute and relative reductions in DKA admissions",
       subtitle = "Proportional change in inpatient admission count for DKA between 2019-20 by NHSE Region",
       caption = "Proportional change = change between 2019-20 / total admission count for 2019")

# Age
e_DKA_cum_diff_age_range <-
  e_get_attendance_diff_DKA(Age_range) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_diff)) %>% 
  pivot_longer(cols = c(-week_number, -demographic_var),
               names_to = "trend", 
               values_to = "count") %>% 
  filter(trend == "cum_def") %>% 
  filter(week_number < 53) %>% 
  drop_na(demographic_var) %>% 
  ungroup()

e_DKA_cum_diff_age_range_vis <-
  e_DKA_cum_diff_age_range %>%
  filter(demographic_var != "100+") %>%
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  ggplot(aes(week_number, count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_SU(palette = "main") +
  theme(legend.position = "none") +
  labs(title = "Magnitute and direction of change in DKA admission varies by age range", 
       subtitle = "Cumulative change in weekly admission count for DKA between 2019 and 2020, by Age range",
       caption = "Admission difference = 2020 count - 2019 count",
       x = "Week number",
       y = "Cumulative admission difference")

# Age range - proportional difference between 2019-2020
e_DKA_prop_diff_age <-
  e_get_attendance_diff_DKA(Age_range) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_diff = sum(PC_diff, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(diff_prop = sum_diff/sum_2019*100) %>% 
  mutate(sum_diff_adj = case_when(sum_diff >= 0 ~ sum_diff,
                                  sum_diff < 0 ~ -sum_diff )) %>% 
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_diff >= 0 ~ LCI, sum_diff < 0 ~ -LCI),
         UCI = case_when(sum_diff >= 0 ~ UCI, sum_diff < 0 ~ -UCI))  # Return CI's to negative where the def was negative

e_DKA_prop_diff_age_vis <-
  e_DKA_prop_diff_age %>% 
  filter(demographic_var != "100+") %>% 
  ggplot(aes(y = demographic_var, x = diff_prop)) +
  geom_col(fill = "#f9bf07", colour = "#636363") +
  geom_errorbar(aes(xmin=LCI, xmax=UCI), width = 0.25, colour = "#636363") +
  labs(x = "Proportional change", 
       y = "Age range",
       title = "20-39 year old's saw a significant reduction in DKA admissions during pandemic",
       subtitle = "Proportional change in inpatient admission count for DKA between 2019-20 by age range",
       caption = "Proportional change = change between 2019-20 / total admission count for 2019")

# Deprivation
e_DKA_cum_diff_deprivation <-
  e_get_attendance_diff_DKA(IMD_Quintile) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_diff)) %>% 
  pivot_longer(cols = c(-week_number, -demographic_var),
               names_to = "trend", 
               values_to = "count") %>% 
  filter(trend == "cum_def") %>% 
  filter(week_number < 53) %>% 
  drop_na(demographic_var) %>% 
  ungroup() %>% 
  mutate(demographic_var = factor(demographic_var, levels = c(1,2,3,4,5)))

e_DKA_cum_diff_deprivation_vis <-
  e_DKA_cum_diff_deprivation %>%
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  filter(demographic_var != "100+") %>% 
  ggplot(aes(week_number, count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_SU(palette = "main") +
  theme(legend.position = "none") +
  labs(title = "Deprivation quintiles diverge at the onset of the second lockdown", 
       subtitle = "Cumulative change in weekly admission count for DKA between 2019 and 2020, by IMD Quintile ",
       caption = "Admission difference = 2020 count - 2019 count",
       x = "Week number",
       y = "Cumulative admission difference")

# Deprivation - proportional difference between 2019-2020
e_DKA_prop_diff_deprivation <-
  e_get_attendance_diff_DKA(IMD_Quintile) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_diff = sum(PC_diff, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(diff_prop = sum_diff/sum_2019*100) %>% 
  mutate(sum_diff_adj = case_when(sum_diff >= 0 ~ sum_diff,
                                  sum_diff < 0 ~ -sum_diff )) %>% 
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_diff >= 0 ~ LCI, sum_diff < 0 ~ -LCI),
         UCI = case_when(sum_diff >= 0 ~ UCI, sum_diff < 0 ~ -UCI)) %>%   # Return CI's to negative where the def was negative
  mutate(demographic_var = factor(demographic_var, levels = c(1,2,3,4,5)))

e_DKA_prop_diff_deprivation_vis <-
  e_DKA_prop_diff_deprivation %>% 
  drop_na(demographic_var) %>% 
  ggplot(aes(y = demographic_var, x = diff_prop)) +
  geom_col(fill = "#f9bf07", colour = "#636363") +
  geom_errorbar(aes(xmin=LCI, xmax=UCI), width = 0.25, colour = "#636363") +
  labs(x = "Proportional change", 
       y = "IMD Quintile",
       title = "DKA reductions  were focused on the extremes of deprivation and affluence",
       subtitle = "Proportional change in inpatient admission count for DKA between 2019-20 by IMD Quintile",
       caption = "Proportional change = change between 2019-20 / total admission count for 2019")

# Ethnicity
# Ethnic_Category_Desc
e_DKA_cum_diff_ethnicity <-
  e_get_attendance_diff_DKA(Ethnicity_broad) %>% 
  group_by(demographic_var) %>% 
  mutate(cum_def = cumsum(PC_diff)) %>% 
  pivot_longer(cols = c(-week_number, -demographic_var),
               names_to = "trend", 
               values_to = "count") %>% 
  filter(trend == "cum_def") %>% 
  filter(week_number < 53) %>% 
  drop_na(demographic_var) %>% 
  ungroup() 

e_DKA_cum_diff_ethnicity_vis <-
  e_DKA_cum_diff_ethnicity %>%
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  filter(demographic_var != "100+") %>% 
  ggplot(aes(week_number, count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_SU(palette = "main") +
  theme(legend.position = "none") +
  labs(title = "...", 
       subtitle = "Change in weekly admission count for DKA between 2019 and 2020, by broad ethnicity",
       caption = "Admission difference = 2020 count - 2019 count",
       x = "Week number",
       y = "Cumulative admission difference")

# Excluding white group - Interesting
e_DKA_cum_diff_ethnicity_nonWhite_vis <-
e_DKA_cum_diff_ethnicity %>%
  filter(demographic_var != "White") %>% 
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  filter(demographic_var != "100+") %>% 
  ggplot(aes(week_number, count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_SU(palette = "main") +
  theme(legend.position = "none") +
  labs(title = "...", 
       subtitle = "Change in weekly admission count for DKA between 2019 and 2020, by broad ethnicity",
       caption = "Admission difference = 2020 count - 2019 count",
       x = "Week number",
       y = "Cumulative admission difference")

# Ethnicity - proportional difference between 2019-2020
e_DKA_prop_diff_ethnicity <-
  e_get_attendance_diff_DKA(Ethnic_Category_Desc) %>% 
  drop_na(demographic_var) %>% 
  group_by(demographic_var) %>% 
  summarise(sum_diff = sum(PC_diff, na.rm = TRUE),
            sum_2019 = sum(n_2019, na.rm = TRUE)) %>% 
  mutate(diff_prop = sum_diff/sum_2019*100) %>% 
  mutate(sum_diff_adj = case_when(sum_diff >= 0 ~ sum_diff,
                                  sum_diff < 0 ~ -sum_diff )) %>% 
  group_by(demographic_var) %>% 
  mutate(LCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[1]*100,
         UCI = add4ci(x = sum_diff_adj, n = sum_2019, 0.95)$conf.int[2]*100) %>%
  mutate(LCI = case_when(sum_diff >= 0 ~ LCI, sum_diff < 0 ~ -LCI),
         UCI = case_when(sum_diff >= 0 ~ UCI, sum_diff < 0 ~ -UCI))

e_DKA_prop_diff_ethnicity_vis <-
  e_DKA_prop_diff_ethnicity %>% 
  ggplot(aes(y = reorder(demographic_var, diff_prop), x = diff_prop)) +
  geom_col(fill = "#f9bf07", colour = "#636363") +
  geom_errorbar(aes(xmin=LCI, xmax=UCI), width = 0.25, colour = "#636363") +
  labs(x = "Proportional change", 
       y = "Ethnicity",
       title = "Large proportional increase seen in Black subgroups",
       subtitle = "Proportional change in inpatient admission count for DKA between 2019-20 by ethnicity",
       caption = "Proportional change = change between 2019-20 / total admission count for 2019")



## Proportional changes in DKA and Type 1/2  ####

# Region 
e_scatter_region_DKAvsType1 <-
e_DKA_prop_diff_region %>% 
  mutate(conf = UCI - LCI) %>% 
  select(demographic_var, diff_prop, conf) %>% 
  rename(DKA_prop_change = diff_prop) %>% 
  left_join(e_type1_prop_diff_region %>% 
              mutate(conf = UCI - LCI) %>% 
              select(demographic_var, diff_prop, conf) %>% 
              rename(Type1_prop_change = diff_prop), 
            by = c("demographic_var")) %>%
  mutate(confidence = mean(conf.x, conf.y)) %>% 
  ungroup() %>%
  mutate(conf_tertile = 
           case_when(
             confidence < quantile(confidence, probs = 0.33) ~ "High",
             confidence > quantile(confidence, probs = 0.33) & confidence < quantile(confidence, probs = 0.66) ~ "Medium",
             confidence > quantile(confidence, probs = 0.66) ~ "Low"
           ))  %>% 
  mutate(conf_tertile = factor(conf_tertile, levels = c("Low", "Medium", "High"))) 

e_scatter_region_DKAvsType2 <-
  e_DKA_prop_diff_region %>% 
  mutate(conf = UCI - LCI) %>% 
  select(demographic_var, diff_prop, conf) %>% 
  rename(DKA_prop_change = diff_prop) %>% 
  left_join(e_type2_prop_diff_region %>% 
              mutate(conf = UCI - LCI) %>% 
              select(demographic_var, diff_prop, conf) %>% 
              rename(Type2_prop_change = diff_prop), 
            by = c("demographic_var")) %>%
  mutate(confidence = mean(conf.x, conf.y)) %>% 
  ungroup() %>%
  mutate(conf_tertile = 
           case_when(
             confidence < quantile(confidence, probs = 0.33) ~ "High",
             confidence > quantile(confidence, probs = 0.33) & confidence < quantile(confidence, probs = 0.66) ~ "Medium",
             confidence > quantile(confidence, probs = 0.66) ~ "Low"
           ))  %>% 
  mutate(conf_tertile = factor(conf_tertile, levels = c("Low", "Medium", "High"))) 

e_DKAvsType1_2_patch_region <-
(
# Type 1
  e_scatter_region_DKAvsType1 %>% 
  ggplot(aes(x = DKA_prop_change, y = Type1_prop_change, label = str_wrap(demographic_var, 12))) + 
  geom_vline(aes(xintercept = mean(DKA_prop_change)), linetype = "dashed", colour = "#636363") +
  geom_hline(aes(yintercept = mean(Type1_prop_change)), linetype = "dashed", colour = "#636363") +
  geom_point(
    #aes(alpha = conf_tertile), 
    fill = "#f9bf07", colour = "black", pch = 21, size = 7) +
  geom_text_repel(box.padding = 1, size = 3) +
    theme(legend.position = "none") +
  labs(title = "Proportional disruption in DKA and Type 1 ED attendance was heightening in East of Engalnd",
       subtitle = "Proportional change in diabetes activity by NHSE Region",
       caption = "Dashed line: Axis mean",
       x = "Change in DKA admissions",
       y = "Change in type 1 diabetes ED attendances",
       alpha = "Confidence")
) +
  (
    # Type 2
    e_scatter_region_DKAvsType2 %>% 
      ggplot(aes(x = DKA_prop_change, y = Type2_prop_change, label = str_wrap(demographic_var, 12))) + 
      geom_vline(aes(xintercept = mean(DKA_prop_change)), linetype = "dashed", colour = "#636363") +
      geom_hline(aes(yintercept = mean(Type2_prop_change)), linetype = "dashed", colour = "#636363") +
      geom_point(
        #aes(alpha = conf_tertile), 
        fill = "#f9bf07", colour = "black", pch = 21, size = 7) +
      geom_text_repel(box.padding = 1, size = 3) +
      labs(x = "Change in DKA admissions",
           y = "Change in type 2 diabetes ED attendances",
           alpha = "Confidence")
  )

# Age range
e_scatter_age_DKAvsType1 <-
  e_DKA_prop_diff_age %>%
  filter(demographic_var != "100+") %>%
  mutate(conf = UCI - LCI) %>% 
  select(demographic_var, diff_prop, conf) %>% 
  rename(DKA_prop_change = diff_prop) %>% 
  left_join(e_type1_prop_diff_age %>% 
              mutate(conf = UCI - LCI) %>% 
              select(demographic_var, diff_prop, conf) %>% 
              rename(Type1_prop_change = diff_prop), 
            by = c("demographic_var")) %>%
  mutate(confidence = mean(conf.x, conf.y)) %>% 
  ungroup() %>%
  mutate(conf_tertile = 
           case_when(
             confidence < quantile(confidence, probs = 0.33) ~ "High",
             confidence > quantile(confidence, probs = 0.33) & confidence < quantile(confidence, probs = 0.66) ~ "Medium",
             confidence > quantile(confidence, probs = 0.66) ~ "Low"
           ))  %>% 
  mutate(conf_tertile = factor(conf_tertile, levels = c("Low", "Medium", "High"))) 

e_scatter_age_DKAvsType2 <-
  e_DKA_prop_diff_age %>% 
  mutate(conf = UCI - LCI) %>% 
  select(demographic_var, diff_prop, conf) %>% 
  rename(DKA_prop_change = diff_prop) %>% 
  left_join(e_type2_prop_diff_age %>% 
              mutate(conf = UCI - LCI) %>% 
              select(demographic_var, diff_prop, conf) %>% 
              rename(Type2_prop_change = diff_prop), 
            by = c("demographic_var")) %>%
  mutate(confidence = mean(conf.x, conf.y)) %>% 
  ungroup() %>%
  mutate(conf_tertile = 
           case_when(
             confidence < quantile(confidence, probs = 0.33) ~ "High",
             confidence > quantile(confidence, probs = 0.33) & confidence < quantile(confidence, probs = 0.66) ~ "Medium",
             confidence > quantile(confidence, probs = 0.66) ~ "Low"
           ))  %>% 
  mutate(conf_tertile = factor(conf_tertile, levels = c("Low", "Medium", "High"))) 

e_DKAvsType1_2_patch_age <-
(
  # Type 1
  e_scatter_age_DKAvsType1 %>%
    filter(demographic_var != "100+") %>% 
    ggplot(aes(x = DKA_prop_change, y = Type1_prop_change, label = str_wrap(demographic_var, 12))) + 
    geom_vline(aes(xintercept = mean(DKA_prop_change)), linetype = "dashed", colour = "#636363") +
    geom_hline(aes(yintercept = mean(Type1_prop_change)), linetype = "dashed", colour = "#636363") +
    geom_point(
      #aes(alpha = conf_tertile), 
      fill = "#f9bf07", colour = "black", pch = 21, size = 7) +
    geom_text_repel(box.padding = 1, size = 3) +
    theme(legend.position = "none") +
    labs(title = "Increased DKA admissions in 40-69 year old's occuring alongside reduced ED attendences for Type 1 & 2",
         subtitle = "Proportional change in diabetes activity by Age range",
         caption = "Dashed line: Axis mean",
         x = "Change in DKA admissions",
         y = "Change in type 1 diabetes ED attendances",
         alpha = "Confidence")
) +
  (
    # Type 2
    e_scatter_age_DKAvsType2 %>% 
      filter(demographic_var != "100+") %>% 
      ggplot(aes(x = DKA_prop_change, y = Type2_prop_change, label = str_wrap(demographic_var, 12))) + 
      geom_vline(aes(xintercept = mean(DKA_prop_change)), linetype = "dashed", colour = "#636363") +
      geom_hline(aes(yintercept = mean(Type2_prop_change)), linetype = "dashed", colour = "#636363") +
      geom_point(
        #aes(alpha = conf_tertile), 
        fill = "#f9bf07", colour = "black", pch = 21, size = 7) +
      geom_text_repel(box.padding = 1, size = 3) +
      labs(x = "Change in DKA admissions",
           y = "Change in type 2 diabetes ED attendances",
           alpha = "Confidence")
  )

# Deprivation
e_scatter_deprivation_DKAvsType1 <-
  e_DKA_prop_diff_deprivation %>%
  filter(demographic_var != "100+") %>%
  mutate(conf = UCI - LCI) %>% 
  select(demographic_var, diff_prop, conf) %>% 
  rename(DKA_prop_change = diff_prop) %>% 
  left_join(e_type1_prop_diff_deprivation %>% 
              mutate(conf = UCI - LCI) %>% 
              select(demographic_var, diff_prop, conf) %>% 
              rename(Type1_prop_change = diff_prop), 
            by = c("demographic_var")) %>%
  mutate(confidence = mean(conf.x, conf.y)) %>% 
  ungroup() %>%
  mutate(conf_tertile = 
           case_when(
             confidence < quantile(confidence, probs = 0.33) ~ "High",
             confidence > quantile(confidence, probs = 0.33) & confidence < quantile(confidence, probs = 0.66) ~ "Medium",
             confidence > quantile(confidence, probs = 0.66) ~ "Low"
           ))  %>% 
  mutate(conf_tertile = factor(conf_tertile, levels = c("Low", "Medium", "High"))) 

e_scatter_deprivation_DKAvsType2 <-
  e_DKA_prop_diff_deprivation %>% 
  drop_na(demographic_var) %>% 
  mutate(conf = UCI - LCI) %>% 
  select(demographic_var, diff_prop, conf) %>% 
  rename(DKA_prop_change = diff_prop) %>% 
  left_join(e_type2_prop_diff_deprivation %>% 
              mutate(conf = UCI - LCI) %>% 
              select(demographic_var, diff_prop, conf) %>% 
              rename(Type2_prop_change = diff_prop), 
            by = c("demographic_var")) %>%
  mutate(confidence = mean(conf.x, conf.y)) %>% 
  ungroup() %>%
  mutate(conf_tertile = 
           case_when(
             confidence < quantile(confidence, probs = 0.33) ~ "High",
             confidence > quantile(confidence, probs = 0.33) & confidence < quantile(confidence, probs = 0.66) ~ "Medium",
             confidence > quantile(confidence, probs = 0.66) ~ "Low"
           ))  %>% 
  mutate(conf_tertile = factor(conf_tertile, levels = c("Low", "Medium", "High"))) 

e_DKAvsType1_2_patch_deprivation <-
(
  # Type 1
  e_scatter_deprivation_DKAvsType1 %>%
    filter(demographic_var != "100+") %>% 
    ggplot(aes(x = DKA_prop_change, y = Type1_prop_change, label = str_wrap(demographic_var, 12))) + 
    geom_vline(aes(xintercept = mean(DKA_prop_change)), linetype = "dashed", colour = "#636363") +
    geom_hline(aes(yintercept = mean(Type1_prop_change)), linetype = "dashed", colour = "#636363") +
    geom_point(
      #aes(alpha = conf_tertile), 
      fill = "#f9bf07", colour = "black", pch = 21, size = 7) +
    geom_text_repel(box.padding = 1, size = 3) +
    theme(legend.position = "none") +
    labs(title = "More deprieved 40% saw higher proportional reduction in all diabetes activity",
         subtitle = "Proportional change in diabetes activity by IMD Quintile ",
         caption = "Dashed line: Axis mean",
         x = "Change in DKA admissions",
         y = "Change in type 1 diabetes ED attendances",
         alpha = "Confidence")
) +
  (
    # Type 2
    e_scatter_deprivation_DKAvsType2 %>% 
      filter(demographic_var != "100+") %>% 
      ggplot(aes(x = DKA_prop_change, y = Type2_prop_change, label = str_wrap(demographic_var, 12))) + 
      geom_vline(aes(xintercept = mean(DKA_prop_change)), linetype = "dashed", colour = "#636363") +
      geom_hline(aes(yintercept = mean(Type2_prop_change)), linetype = "dashed", colour = "#636363") +
      geom_point(
        #aes(alpha = conf_tertile), 
        fill = "#f9bf07", colour = "black", pch = 21, size = 7) +
      geom_text_repel(box.padding = 1, size = 3) +
      labs(x = "Change in DKA admissions",
           y = "Change in type 2 diabetes ED attendances",
           alpha = "Confidence")
  )

# Ethnicity
e_scatter_ethnicity_DKAvsType1 <-
  e_DKA_prop_diff_ethnicity %>%
  filter(demographic_var != "100+") %>%
  mutate(conf = UCI - LCI) %>% 
  select(demographic_var, sum_2019, diff_prop, conf) %>% 
  rename(DKA_prop_change = diff_prop) %>% 
  left_join(e_type1_prop_diff_ethnicity %>% 
              mutate(conf = UCI - LCI) %>% 
              select(demographic_var, sum_2019, diff_prop, conf) %>% 
              rename(Type1_prop_change = diff_prop), 
            by = c("demographic_var")) %>%
  mutate(confidence = mean(conf.x, conf.y)) %>% 
  ungroup() %>%
  group_by(demographic_var) %>% 
  mutate(Frequency = sum(sum_2019.x, sum_2019.y)) %>% 
  ungroup() %>%
  mutate(Frequency_tertile = 
           case_when(
             Frequency <= quantile(Frequency, probs = 0.33) ~ "Low",
             Frequency > quantile(Frequency, probs = 0.33) & Frequency < quantile(Frequency, probs = 0.66) ~ "Medium",
             Frequency >= quantile(Frequency, probs = 0.66) ~ "High"
           ))  %>% 
  mutate(Frequency_tertile = factor(Frequency_tertile, levels = c("Low", "Medium", "High"))) 

e_scatter_ethnicity_DKAvsType2 <-
  e_DKA_prop_diff_ethnicity %>% 
  drop_na(demographic_var) %>% 
  mutate(conf = UCI - LCI) %>% 
  select(demographic_var, sum_2019, sum_2019, diff_prop, conf) %>% 
  rename(DKA_prop_change = diff_prop) %>% 
  left_join(e_type2_prop_diff_ethnicity %>% 
              mutate(conf = UCI - LCI) %>% 
              select(demographic_var, sum_2019, diff_prop, conf) %>% 
              rename(Type2_prop_change = diff_prop), 
            by = c("demographic_var")) %>%
  mutate(confidence = mean(conf.x, conf.y)) %>% 
  ungroup() %>%
  group_by(demographic_var) %>% 
  mutate(Frequency = sum(sum_2019.x, sum_2019.y)) %>% 
  ungroup() %>%
  mutate(Frequency_tertile = 
           case_when(
             Frequency <= quantile(Frequency, probs = 0.33) ~ "Low",
             Frequency > quantile(Frequency, probs = 0.33) & Frequency < quantile(Frequency, probs = 0.66) ~ "Medium",
             Frequency >= quantile(Frequency, probs = 0.66) ~ "High"
           ))  %>% 
  mutate(Frequency_tertile = factor(Frequency_tertile, levels = c("Low", "Medium", "High")))

e_DKAvsType1_2_patch_ethnicity <-
(
  # Type 1
  e_scatter_ethnicity_DKAvsType1 %>%
    filter(demographic_var != "Chinese") %>%  ## NaN value removed
    ggplot(aes(x = DKA_prop_change, y = Type1_prop_change, label = str_wrap(demographic_var, 12))) + 
    geom_vline(aes(xintercept = mean(DKA_prop_change)), linetype = "dashed", colour = "#636363") +
    geom_hline(aes(yintercept = mean(Type1_prop_change)), linetype = "dashed", colour = "#636363") +
    geom_point(
      aes(size  = Frequency_tertile), 
      fill = "#f9bf07", colour = "black", pch = 21) +
    geom_text_repel(box.padding = 0.8, size = 2, max.overlaps = 100) +
    theme(legend.position = "none") +
    labs(title = "African's had increased DKA admissions and some of the least reduced ED attendances",
         subtitle = "Proportional change in diabetes activity by ethnicity ",
         caption = "Dashed line: Axis mean",
         x = "Change in DKA admissions",
         y = "Change in type 1 diabetes ED attendances",
        size = "Frequency")
) +
  (
    # Type 2
    e_scatter_ethnicity_DKAvsType2 %>% 
      filter(demographic_var != "White and asian") %>%  ## NaN value removed
      ggplot(aes(x = DKA_prop_change, y = Type2_prop_change, label = str_wrap(demographic_var, 12))) + 
      geom_vline(aes(xintercept = mean(DKA_prop_change)), linetype = "dashed", colour = "#636363") +
      geom_hline(aes(yintercept = mean(Type2_prop_change)), linetype = "dashed", colour = "#636363") +
      geom_point(
        aes(size  = Frequency_tertile), 
        fill = "#f9bf07", colour = "black", pch = 21) +
      geom_text_repel(box.padding = 0.8, size = 2,max.overlaps = 100) +
      labs(x = "Change in DKA admissions",
           y = "Change in type 2 diabetes ED attendances",
           size = "Frequency")
  )






## Severity ####
# DKA LoS 
# LoS time series 
g_ip_diabetes_diag_DKA_LoS_ts <-
  g_ip_diabetes_diag_DKA %>% 
  mutate(Der_CC_days = Der_Episode_LoS - Der_Episode_Adj_LoS) %>% 
  group_by(APCE_Ident) %>% 
  mutate(Spell_LoS = sum(Der_Episode_LoS),
         Spell_CC_days = sum(Der_CC_days)) %>% 
  ungroup() %>% 
  mutate(Admission_week = floor_date(Admission_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, diabetes_type) %>% 
  summarise(Activity = n_distinct(APCS_Ident),
            Mean_LoS_wk = mean(Spell_LoS),
            Mean_CC_days_per_spell = mean(Spell_CC_days)) %>% 
  #filter(Admission_week >= "2020-01-01") %>% 
  filter(Admission_week < "2020-12-31") %>% 
  ungroup() 

g_ip_diabetes_diag_DKA_LoS_ts_vis <-
g_ip_diabetes_diag_DKA_LoS_ts %>% 
  filter(diabetes_type != "Unknown") %>% 
  ggplot(aes(x = Admission_week, y = Mean_LoS_wk, colour = diabetes_type, group = diabetes_type)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 8, label = str_wrap("Lockdown", 10) ,size = 2.5, angle = 90) +
  annotate("text", x = as.Date("2020-08-24"), y = 8, label = str_wrap("Recovery", 10) ,size = 2.5, angle = 90) +
  annotate("text", x = as.Date("2020-11-24"), y = 8, label = str_wrap("Lockdown", 10) ,size = 2.5, angle = 90) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU(palette = "main") +
  labs(x = "Date",
       y = "Average admission length (Days)",
       title = "DKA associated LoS was most influenced by COVID-19 in type 2 diabetics",
       subtitle = "Weekly mean length of stay for inpatient DKA admissions by diabetes type, National 2018-20",
       color = "Diabetes type")

g_ip_diabetes_diag_DKA_LoS_ts_critical_care <-
g_ip_diabetes_diag_DKA_LoS_ts %>% 
  filter(diabetes_type != "Unknown") %>% 
  ggplot(aes(x = Admission_week, y = Mean_CC_days_per_spell, colour = diabetes_type, group = diabetes_type)) +
  annotate("segment", x = as.Date("2020-03-23"), xend = as.Date("2020-03-23"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-07-04"), xend = as.Date("2020-07-04"), y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = as.Date("2020-10-14"), xend = as.Date("2020-10-14"), y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = as.Date("2020-05-13"), y = 1, label = str_wrap("Lockdown", 10) ,size = 2.5, angle = 90) +
  annotate("text", x = as.Date("2020-08-24"), y = 1, label = str_wrap("Recovery", 10) ,size = 2.5, angle = 90) +
  annotate("text", x = as.Date("2020-11-24"), y = 1, label = str_wrap("Lockdown", 10) ,size = 2.5, angle = 90) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU(palette = "main") +
  labs(x = "Date",
       y = "Average number critical care days per admission",
       title = "Critical care use was more impacted by COVID-19 in type 2 diabetes DKA admissions",
       subtitle = "Weekly mean number of critical care days per inpatient DKA admissions by diabetes type, National 2018-20",
       color = "Diabetes type")
```

# Executive summary

<br>
Reductions in ED attendances for diabetes focused on lockdown 1. Attendance rates returned during recovery phase with a small second reduction during lockdown 2 (Fig. 1.1). Considerable variation regionally but North East & Yorkshire and the Midlands regions were most impacted proportionally (Fig. 1.7).
Coding issue lead to presentation of ED attendances for type 1  and type 2 diabetes separately, both excluding attendances for DKA.

**Type 1 diabetes** 

-	Deprivation gradient seen in attendance frequency and covid-19 related reductions despite equally distributed prevalence of type 1 diabetes in the population. Proportionally, the most affluent quintile experienced the smallest reductions in attendance (Fig. 2.2.10).
-	Attendances were most frequent in under 40s with the under 20s having a significantly smaller reduction in attendance rates than other age ranges (Fig. 2.2.7).


**Type 2 diabetes**

-	Two distinct trends in cumulative and proportional attendance difference by region; sustained and growing attendance deficit in the Midlands, London and the North East & Yorkshire, while other regions cumulative reduction began to recover after lockdown 1 (Fig. 2.3.3).
-	Proportional attendance difference for the 40-59 years age group significantly lower than other age ranges due to the sharp return to above pre-pandemic rates of attendance, suggesting a backlog of activity was created during lockdown 1 which then presented during the recovery (see Fig. 2.3.6).
-	The Asian population experienced larger cumulative and proportional reductions in attendance rates than expected, mostly driven by reductions in ED attendances in Indian and Pakistani sub-groups (Fig. 2.3.12).

**Inpatient DKA admissions**

The seasonal and fluctuating nature of admission rates for DKA were not obviously impacted by the covid-19 pandemic (Fig. 2.4.1). Admissions were more frequent in type 1 diabetics at a ratio of approx. 3 in every 4 admissions for DKA, despite the higher prevalence of type 2 diabetes.
The concerning combination of reduced ED attendances for less severe diabetes related emergencies and unchanged levels of or increases in inpatient DKA admissions were seen in: 

-	Type 2 diabetics in London (Fig. 2.4.6),
-	60-79 year old type 1 diabetics (Fig. 2.4.10) and 
-	Pakistani and Caribbean ethnicities (Fig. 2.4.17).

The above may suggest hesitancy to attend ED at the earlier stages of an acute complication of diabetes is contributing to increased rates of more severe admissions for DKA. The inverse was seen in the most affluent 20% of the population, where lesser reduced levels of ED attendance in type 1 diabetes were seen with high reductions in DKA admission rates (Fig. 2.4.13). 


# Background
## Diabetes care during a pandemic
The management of diabetes has long been spread across primary and secondary care providers and as such the effect of COVID-19 is less clear. It is conceivable that disrupted specialist input for type 1 and particularly high-risk type 2 patients has led to an increase in emergency attendance for hypo or hyperglycaemic events. Similarly, media and public perception of the stress upon the healthcare system may have reduced care seeking behaviour in individuals who did not feel safe attending A&E where they may have otherwise, potentially leading to worst outcomes when care was finally sought. Research from the Strategy Unit, Health Foundation and Nuffield Trust  would suggest reduced care seeking would be disproportionately seen in certain ethnic minorities and cultural groups, thereby widening existing inequities in treatment and outcomes [1]

# Methods

## Data collection
### Late diagnosis or acute complications of diabetes
Emergency attendances indicative of either late diagnosis or acute complications of diabetes were identified using SNOMED-CT diagnosis codes. Conditions included:  

-	Hyperglycemia 
-	Diabetic ketoacidosis (DKA)
-	Other acute metabolic complications of diabetes (hyperlipidaemia, hyperosmolarity and dyslipidaemia) 
-	Coma due to diabetes (either direction, hyper/hypo)
-	Hypoglycemia
-	Diabetes related findings (high blood sugar, increased glucose level)

## Project scope
The strategy unit proposes to quantify the changes in secondary care emergency admissions in diabetic patients according to similarly selected population groups. 

## Analysis plan 

Plan: 

* Adjust SQL - diagnosis SNOMED-CT codes
* Organise data in terms of: 
  * Demographics (age, deprivation, ethnicity), 
  * Geography, 
  * Diabetes type, 
  * Primary complaint and 
  * Outcome (admission or not)
* Present trends in above variables and explore further interactions
<br>
<br>
Main unit of measure will be attendance change, comparing attendances between 2020 and 2019. 2019 data used as proxy for expected levels of demand in the absence of the pandemic. 
<br>

# COVID-19 impact diabetes activity

## Emergency attendances

<br>
Fig. 1.1
``` {r Diabetes emergency activity, warning = FALSE, message = FALSE, echo = FALSE}
b_diabetes_ed_daily_vis
```
<br>
Is the increasing trend a data quality issue or a valid pattern? Pre-covid activity rate will determine the extent to which covid has disrupted 'normal' treatment so validity is key.
<br>
<br>
<br>
Fig. 1.2
``` {r Diabetes attendances vs admissions,warning = FALSE, message = FALSE, echo = FALSE}
a.diabetes_ip_unplanned_index %>% 
  mutate(Admission_week = floor_date(as.Date(Admission_Date), unit = "week")) %>% 
  group_by(Admission_week) %>% 
  summarise(IP_Unplanned = sum(Admission_count)) %>% 
  filter(substr(Admission_week,1,4) < 2021) %>% 
  left_join(
    a.diabetes_ip_planned_index %>% 
      mutate(Admission_week = floor_date(as.Date(Admission_Date), unit = "week")) %>% 
      group_by(Admission_week) %>% 
      summarise(IP_Planned = sum(Admission_count)) %>% 
      filter(substr(Admission_week,1,4) < 2021),
    by = c("Admission_week")
  ) %>% 
  left_join(
    g_diabetes_demographic_index %>%
      mutate(Admission_week = floor_date(as.Date(Arrival_Date), unit = "week")) %>%
      group_by(Admission_week) %>% 
      summarise(ED_Attendances = sum(Admission_count)) %>% 
      filter(substr(Admission_week,1,4) < 2021),
    by = c("Admission_week")
  ) %>% 
  pivot_longer(cols = -Admission_week, 
               names_to = "Admissions", 
               values_to = "Count") %>% 
  
  ggplot(aes(x = Admission_week, y = Count, colour = Admissions)) + 
  geom_smooth(method = 'loess', span = 0.3) +
  scale_color_SU(palette = "main") +
  labs(x = "Week", 
       y = "Admissions/attendances",
       title = "Sharp increase in ED activity is likely fueled by increased data completeness quality",
       subtitle = "Weekly activity for Diabetes - Type 1 and 2", 
       caption = "Emergency department (ED) attendances and Inpatient (planned and unplanned) admissions, National 2018-20")

```
<br>
Consistent rates of planned and unplanned diabetes inpatient admissions suggest we would expect to see a flat trend in pre-covid ED attendances.
<br>
<br>
<br>
Fig. 1.3
``` {r Diabetes emergency activity - year on year,  warning = FALSE, message = FALSE, echo = FALSE}
g_diabetes_week_number_wide %>% 
  pivot_longer(cols = -week_number,
               names_to = "trend",
               values_to = "count") %>% 
  filter(trend != c("def","PC_def")) %>% 
  
  ggplot(aes(x = week_number, y = count, colour = trend)) +
  geom_smooth(method = "loess", span = 0.3) + 
  scale_colour_manual(values = c("#f9bf07", "#686f73", "#5881c1", "#ec6555")) +
  labs(title = "Year-on-year ED attendances for diabetes", 
       subtitle = "National, 2018-20", 
       x = "Week", y = "Attendance count")
```
<br>
By comparing yearly activity we can see that the 2019 trend serves as a useful counterfactual to compare 2020 activity against, as a proxy for what we would expect in the absence of covid-19. Data quality issues with the 2018 trend serves to lower the 2018-19 average considerably and artificially. 
<br>
<br>
<br>
Fig. 1.4
``` {r diabetes ED annual trends, warning = FALSE, message = FALSE, echo = FALSE}
# Patch
g_diabetes_annual_trends + g_diabetes_admission_def_vis + 
  plot_annotation(title = "Yearly patterns in diabetes emergency attendances",
                  subtitle = "National, Weekly elective inpatient procedures, 2018-20")
```
<br>
Comparing the trend in ED attendances for diabetes related emergencies, we can see that there was a reduction in attendances in 2020 compared to 2019. The reduction was focused on the first national lockdown period and had returned to expected levels by the 'recovery' period.
<br>
We will assess whether avoided attendances were distributed evenly through the population subgroups.
<br>
<br>
<br>
Fig. 1.5
``` {r diabetes ED annual trends by region, warning = FALSE, message = FALSE, echo = FALSE}
# Region
g_get_admission_deficit_diabetes(nhser20nm) %>% 
  drop_na(demographic_var) %>% 
  pivot_longer(cols = c(-week_number, - demographic_var),
               names_to = "trend", 
               values_to = "Attendance_count") %>% 
  filter(trend %in% c("n_2020", "n_2019")) %>% 
  mutate(trend = case_when(trend == "n_2020" ~ "2020",
                           trend == "n_2019" ~ "2019"))  %>% 
  
  ggplot(aes(x = week_number, y = Attendance_count, colour = trend, group = trend)) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_colour_manual(values = c("#5881c1", "#f9bf07")) +
  facet_wrap(~ demographic_var) +
  # Covid timeline markers
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = 375, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  annotate("text", x = 34, y = 375, label = str_wrap("Recovery", 10) ,size = 2.5) +
  annotate("text", x = 48, y = 375, label = str_wrap("Lockdown", 10) ,size = 2.5) +
  theme(strip.text = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 12),
        legend.position = c(0.85, 0.2)) +
  labs(x = "Week number", y = "Admissions", colour = "",
       title = "Most variation from the previous year's norm occurs during lockdown 1",
       subtitle = "ED attendances for diabetes in 2019 and 2020 by NHSE region")

```
<br>
There is considerable variation in terms of pre-covid diabetes attendance volume and pandemic-induced reductions. The North East and Yorkshire and the Midlands regions have high pre-covid attendance volumes and considerable reductions during lockdown; both factors contributing to large cumulative reductions below.  
<br>
<br>
<br>
Fig. 1.6
``` {r Regional deficit, , warning = FALSE, message = FALSE, echo = FALSE}
g_diab_ed_deficit_cum_region_vis
```
<br>
The cumulative difference in diabetes ED attendance for the South East is an outlier in that lockdown 1 saw a small reduction in ED demand with the increases during recovery period. This trend may suggest a backlog was created during the national lockdown that presented during the recovery phase.
<br>
<br>
<br>
Fig. 1.7
``` {r Regional deficit proportion , warning = FALSE, message = FALSE, echo = FALSE}
g_diab_ed_deficit_prop_region_vis
```
<br>
The highest levels of avoided or disrupted ED attendances were seen in the North East & Yorkshire and the Midlands, proportionally and in absolute terms. The North East & Yorkshire region saw 10% less demand for diabetes care in the ED than they would have expected, based on 2019 data.
<br>
<br>
<br>


## Findings by condition 

Fig. 2.1
``` {r coding limitations, warning = FALSE, message = FALSE, echo = FALSE}
g_diabetes_demographic_index %>% 
  mutate(Admission_week = floor_date(Arrival_Date, unit = "week")) %>% 
  ungroup() %>% 
  group_by(Admission_week, Description) %>% 
  summarise(Activity = sum(Admission_count)) %>% 
  drop_na(Description) %>% 
  filter(Admission_week > "2019-01-01") %>% 
  
  ggplot(aes(x = Admission_week, y = Activity, colour = Description)) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU(palette = "main") +
  labs(x = "Date", y =  "Attendances", 
       title = "Coding of SNOMED-CT ID's is limitted to 6 diabetes diagnoses", 
       subtitle = "Weekly admission count by primary diagnosis, National 2019-20")
```
<br>
**Coding issues**
<br>
60 snomed-ct diagnosis ID's were used to search for diabetes-related ED attendances which identified 50-80 thousand attendances per year. Of the 60 diagnosis codes included in the data query, only the above 6 are present in the data. This may be expected given ED coding is in the gradual process of moving between systems (AEA to ECDS). 
<br>
Only broad, high level snomed-ct ID's appear to be in use, creating difficulties in identifying which type of diabetes the patient had when treated for DKA, for example. In this case, we have searched for secondary diagnosis codes which indicate the type of diabetes however almost 80% of records only have a primary snomed-ct code input. We attempted to use the record's 'Chief complaint' field to identify diabetes type where not explicitly stated, however this reduced all diabetes-related attendances to either hypo- or hyper-glycaemia. Finally, we took a similar approach using the accompanying AEA diagnosis field, however again this did not offer enough granularity and classified diabetes-related records as either:

* 301: Diabetes and other endocrinological conditions - Diabetic
* 302: Diabetes and other endocrinological conditions - Other non-diabetic

<br>
As such, given the assumption that almost all DKA attendances would result in an admission, we will focus on inpatient data with regard to DKA where we can more accurately split data by diabetes type. We will therefore present trends in ED attendance for type 1 and Type 2 diabetes not including DKA.
<br>

### Type 1 Diabetes

#### National & regional trends

<br>
Fig. 2.2.1
``` {r ED attendances for type 1 diabetes, warning = FALSE, message = FALSE, echo = FALSE}
g_type1_weekly_count_vis
```
<br>
We see a significant pandemic-induced reduction in ED attendances for type 1 diabetes at the national level. The attendance rate increases during the recovery period but has not yet returned to the pre-pandemic level. 
<br>
<br>
<br>
Fig. 2.2.2
``` {r ED attendances for type 1 diabetes - region, warning = FALSE, message = FALSE, echo = FALSE}
g_type1_weekly_count_region_vis
```
<br>
Attendance rates for type 1 diabetes do not differ greatly be region, as displayed by the overlapping gray confidence intervals. All show a reducing attendance rate before the national lockdown but the magnitude of  the impact varies regionally, with the Midlands experiencing a steep reduction in attendance since the end of 2019.
<br>
<br>
<br>
Fig. 2.2.3
``` {r ED attendances for type 1 diabetes - region cum diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type1_cum_diff_region_vis
```
<br>
By displaying cumulative difference in attendance we can see the lasting impact of the pandemic over the year. We see that the Midlands and the North East and Yorkshire saw the largest reduction in attendances compared to the expected levels seen in 2019. This may be a function of patient population sizes so serves to demonstrate absolute not relative impacts.  
<br>
<br>
<br>
Fig. 2.2.4
``` {r ED attendances for type 1 diabetes - region prop diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type1_prop_diff_region_vis
```
<br>
While it is note worthy than all regions experienced a reduction in demand, proportional comparisons suggest the Midlands received over 25% less attendances for type 1 diabetes than they would expect. 
<br>
<br>
<br>

#### Age

Fig. 2.2.5
``` {r ED attendances for type 1 diabetes - age, warning = FALSE, message = FALSE, echo = FALSE}
g_type1_weekly_count_age_vis
```
<br>
The frequency in which type 1 diabetes patients attend ED seems to reduce with increasing age. The most high volume age ranges are the under 40's. Admission rates in those ages 40-99 however have remained consistent throughout the national lockdown periods. 
<br>
<br>
<br>
Fig. 2.2.6
``` {r ED attendances for type 1 diabetes - age cum diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type1_cum_diff_age_range_vis
```
<br>
The cumulative difference is determined by the pre-covid attendance volume and the magnitude of the disruptive covid-19 impact. As such, the greatest cumulative reduction in ED attendance is seen in 20-39 year old's, for which rates continued to drop during the recovery period and the second lockdown.     
<br>
<br>
<br>
Fig. 2.2.7
``` {r ED attendances for type 1 diabetes - age prop diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type1_prop_diff_age_vis
```
<br>
Covid-19 had the least disruptive impact on ED attendances for the under 20 age range; this is due to the steep recovery after the first national lockdown, reducing the overall attendance deficit for this group. 
<br>
<br>
<br>

#### Deprivation

Fig. 2.2.8
``` {r ED attendances for type 1 diabetes - deprivation, warning = FALSE, message = FALSE, echo = FALSE}
g_type1_weekly_count_deprivation_vis
```
<br>
Given that the prevalence of type 1 diabetes is broadly similar across deprivation quintiles, we see inequalities here in the frequency at which more deprived populations require emergency treatment for type 1 diabetes. 

<https://jech.bmj.com/content/54/3/173> 
<br>
<https://pubmed.ncbi.nlm.nih.gov/10975218/>
<br>
<br>
<br>
Fig. 2.2.9
``` {r ED attendances for type 1 diabetes - deprivation cum diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type1_cum_diff_deprivation_vis
```
<br>
Increased demand for care in the more deprived groups translates to a increased cumulative reductions in ED care where we see more deprived populations avoiding, not accessing or not needing emergency care.
<br>
<br>
<br>
Fig. 2.2.10
``` {r ED attendances for type 1 diabetes - deprivation prop diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type1_prop_diff_deprivation_vis
```
<br>
Proportionally we see similar impacts across all of the deprivation quintiles other than the most affluent 20% of the population where we see less of a reduction in ED demand.
<br>
<br>
<br>

#### Ethnicity 

Fig. 2.2.11
``` {r ED attendances for type 1 diabetes - ethnicity, warning = FALSE, message = FALSE, echo = FALSE}
g_type1_weekly_count_ethnicity_broad_facet_vis
```
<br>
High levels of variation/fluctuation seen in non-white ethnicities due to small numbers of attendances - demonstrated by broad grey confidence intervals, as such conclusions are hard to draw from changes in trends. 
<br>
<br>
<br>
Fig. 2.2.12
``` {r ED attendances for type 1 diabetes - ethnicity cum diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type1_cum_diff_ethnicity_vis
```
<br>
Reductions in ED attendances for type 1 diabetes occurred in each ethnic group. Differences in absolute cumulative reductions are driven by population demographics which much higher numbers of patients of white ethnicity.  
<br>
<br>
<br>
Fig. 2.2.13
``` {r ED attendances for type 1 diabetes - ethnicity prop diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type1_prop_diff_ethnicity_vis
```
<br>
All ethnic sub-groups that demonstrate a proportional increase have such broad confidence intervals that limit our ability to draw conclusions.
<br>
<br>
<br>

### Type 2 Diabetes

#### National & regional trends

<br>
Fig. 2.3.1
``` {r ED attendances for type 2 diabetes, warning = FALSE, message = FALSE, echo = FALSE}
g_type2_weekly_count_vis
```
<br>
ED attendances for type 2 diabetes appear to have returned to a stable rate after the initial impact of covid-19. Pre-pandemic rates were very consistent which are mirrored during the recovery and second lockdown phases.
<br>
<br>
<br>
Fig. 2.3.2
``` {r ED attendances for type 2 diabetes - region, warning = FALSE, message = FALSE, echo = FALSE}
g_type2_weekly_count_region_vis
```
<br>
London, Midlands and the North East & Yorkshire experienced higher rates of ED attendances for type 2 diabetes before, during and after the first lockdown; all experiencing significant reductions to attendance rates during the March/April 2020 and recovering to pre-pandemic levels. 
<br>
<br>
<br>
Fig. 2.3.3
``` {r ED attendances for type 2 diabetes - region cum diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type2_cum_diff_region_vis
```
<br>
Two distinct trends are present with the Midlands, London and North East & Yorkshire experiencing sustained reductions in ED attendance for type 2 diabetes, while other regions saw recovery to near or above pre-pandemic rates.
<br>
<br>
<br>
Fig. 2.3.4
``` {r ED attendances for type 2 diabetes - region prop diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type2_prop_diff_region_vis
```
<br>
Trends seen in cumulative differences by region are clear when considering proportion changes; South West, North West and the South East regions experienced increases in the ED attendance rate for type 2 diabetes, significantly higher than would be expected according to 2019 data. 
<br>
<br>
<br>

#### Age

Fig. 2.3.5
``` {r ED attendances for type 2 diabetes - age, warning = FALSE, message = FALSE, echo = FALSE}
g_type2_weekly_count_age_vis
```
<br>
Given the increasing prevalence of type 2 diabetes, it is not surprising that the elderly age groups attend ED for diabetes related emergencies more frequently. In all age ranges, the pre-pandemic attendance volumes were achieved during the recovery period. The 80-99 year old's appear to have experienced the slowest recovery, perhaps linked to the dangers of attending hospital for such high risk groups.
<br>
<br>
<br>
Fig. 2.3.6
``` {r ED attendances for type 2 diabetes - age cum diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type2_cum_diff_age_range_vis
```
<br>
A gradual and considerable cumulative reduction is seen in the oldest age ranges (60-99 years) while the 40-59 year old's demonstrate a markedly different trend where attendances surpassed the previous year's volume to reduce the number of avoided attendances - this perhaps indicative of a backlog built up during the initial lockdown. 
<br>
<br>
<br>
Fig. 2.3.7
``` {r ED attendances for type 2 diabetes - age prop diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type2_prop_diff_age_vis
```
<br>
Proportional variability is seen between age ranges; 40-59 year old's showing minimal overall disruption to ED care while 20% of attendances in the 80+ population were avoided or disrupted by the pandemic.
<br>
<br>
<br>

#### Deprivation

Fig. 2.3.8
``` {r ED attendances for type 2 diabetes - deprivation, warning = FALSE, message = FALSE, echo = FALSE}
g_type2_weekly_count_deprivation_vis
```
<br>
A deprivation gradient is present in type 2 diabetes attendances to ED however it is unclear whether is is simply a function of the greater prevalence of type 2 diabetes in more deprived populations or indicative of further inequality in patient outcomes as well as disease prevalence. 
<br>
<br>
<br>
Fig. 2.3.9
``` {r ED attendances for type 2 diabetes - deprivation cum diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type2_cum_diff_deprivation_vis
```
<br>
All deprivation quintiles experienced reduced demand for care during the first lockdown and plateaued during recovery; however, during the second lockdown we see further reductions in care in the most deprived 40% and increases in attendance for the lesser deprived quintiles 3 and 4.
<br>
<br>
<br>
Fig. 2.3.10
``` {r ED attendances for type 2 diabetes - deprivation prop diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type2_prop_diff_deprivation_vis
```
<br>
When considering proportional changes, we don't see a statistically coherent deprivation gradient in terms of type 2 diabetes attendance. 
<br>
<br>
<br>

#### Ethnicity 

Fig. 2.3.11
``` {r ED attendances for type 2 diabetes - ethnicity, warning = FALSE, message = FALSE, echo = FALSE}
g_type2_weekly_count_ethnicity_broad_facet
```
<br>
<br>
<br>
Fig. 2.3.12
``` {r ED attendances for type 2 diabetes - ethnicity cum diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type2_cum_diff_ethnicity_vis
```
<br>
Though Black and Asian ethnic groups represent similar numbers of ED attendances for type 2 diabetes, the cumulative reduction is much higher in Asians. For the Black population, the reduction plateaued during the recovery phase and stayed level while Asian's continued to not present at ED at the expected rate through recovery and the second lockdown phases.
<br>
<br>
<br>
Fig. 2.3.13
``` {r ED attendances for type 2 diabetes - ethnicity prop diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type2_prop_diff_ethnicity_vis
```
<br>
Significant reductions in Pakistani and Indian populations may have driven the cumulative trend seen above. 
<br>
<br>
<br>

### DKA - Inpatient admissions

<br>
Fig. 2.4.1
```{r DKA weekly count, warning = FALSE, message = FALSE, echo = FALSE}
g_DKA_ip_weekly_count_vis
```
<br>
Inpatient admission rates for DKA had returned to pre-pandemic levels by the end of the recovery period. The behavioural drivers of DKA seem to have persisted around the Christmas and New Year's period of 2020, despite the second national lockdown being in place. Seasonality is also seen in ED data but quality/completeness are issues prior to 2019.
<br>
<br>
<br>
Fig. 2.4.2
```{r DKA weekly count by type, warning = FALSE, message = FALSE, echo = FALSE}
g_DKA_ip_weekly_count_by_type_vis
```
<br>
Though type 1 diabetics represent a much smaller population, they are responsible for more than twice the DKA inpatient admissions. DKA admissions in type 2 diabetics appear less impacted by the pandemic than those in type 1 diabetics. 
<br>
<br>
<br>

#### Region 

<br>
Fig. 2.4.3
```{r DKA weekly count by region, warning = FALSE, message = FALSE, echo = FALSE}
g_DKA_IP_weekly_count_region_vis
```
<br>
Trends in DKA admission by diabetes type are similar and consistent with national trends.
<br>
<br>
<br>
Fig. 2.4.4
```{r DKA weekly count by region - cum diff, warning = FALSE, message = FALSE, echo = FALSE}
e_DKA_cum_diff_region_vis
```
<br>
The cumulative difference in DKA admission varies by region, however all have experienced reductions during the pandemic. The East of England saw the sharpest decline in admissions yet the trend suggests there may have been a delayed effect as the curve is approx 5 weeks behind that of other regions.
<br>
<br>
<br>
Fig. 2.4.5
```{r DKA weekly count by region - prop diff, warning = FALSE, message = FALSE, echo = FALSE}
e_DKA_prop_diff_region_vis
```
<br>
DKA admissions were least reduced in London and the South East with around only 2.5% less DKA admissions than previously seen in 2019. The East of England had the largest proportional reduction in inpatient DKA admissions which was significantly larger than any other region. 
<br>
<br>
<br>
Fig. 2.4.6
```{r DKA vs type 1 and 2 - region, warning = FALSE, message = FALSE, echo = FALSE}
e_DKAvsType1_2_patch_region
```
<br>
When comparing change in ED attendances for diabetes (excluding DKA) and inpatient admissions for DKA, we would expect to see regions in either the bottom left or top right quadrants. 
<br>
We hypothesize the following placements would suggest:

- Bottom left: reductions in demand in both types of presentation
- Top right: Smaller reductions or increases in demand in both types of presentation
- Top left: Less disruption in ED attendance with reductions in DKA suggesting earlier presentation to ED and less severe complications
- Bottom left: Reductions in ED presentation and no reduction or even increases in DKA admissions suggest delayed presentation and more severe outcomes.

<br>
If we accept these assumptions, we see type 2 diabetes in London experiencing delays in presenting to ED with less severe complications and no reduction in more sever DKA admissions.

<br>
<br>
<br>

#### Age 

<br>
Fig. 2.4.7
```{r DKA weekly count by age, warning = FALSE, message = FALSE, echo = FALSE}
g_DKA_IP_weekly_count_age_vis
```
<br>
DKA is distributed differently between age ranges when considering type 1 and type 2 diabetes; in type 1 diabetes, the younger age ranges are more frequently admitted for DKA while in type 2 diabetics, the middle age ranges represent the most at-risk group. It could be hypothesized that lifestyle and behvioural factors are drivers of increased rates in the 20-39 year old type 1 diabetes and familial or social care may reduce rates in 80-99 year old type 2 diabetics.
<br>
<br>
<br>
Fig. 2.4.8
```{r DKA weekly count by age - cum diff, warning = FALSE, message = FALSE, echo = FALSE}
e_DKA_cum_diff_age_range_vis
```
<br>
The youngest age ranges (0-40 years) experienced a largest cumulative reduction in DKA inpatient admissions; where the under 20 admission rate reduced only during lock-downs that of the 20-39 year old's continued to drop during the recovery period as pre-covid rates were not returned to post-lockdwn 1.
<br>
<br>
<br>
Fig. 2.4.9
```{r DKA weekly count by age - prop diff, warning = FALSE, message = FALSE, echo = FALSE}
e_DKA_prop_diff_age_vis
```
<br>
Reductions in under 40's are mostly driven by trends in DKA admissions in type 1 diabetics, while increased DKA admission rates in 40-79 years old's are mostly a result of increased hospitalisations in type 2 diabetics.
<br>
<br>
<br>
Fig. 2.4.10
```{r DKA vs type 1 and 2 - age, warning = FALSE, message = FALSE, echo = FALSE}
e_DKAvsType1_2_patch_age
```
<br>
In type 1 diabetes, we see increases in DKA admissions in 40-59 and 60-79 year old's. According to the above assumptions, we might conclude that increases in 60-79 year old's with DKA were a function of reductions in less severe ED attendances.
<br>
<br>
<br>

#### Deprivation 

<br>
Fig. 2.4.11
```{r DKA weekly count by deprivation, warning = FALSE, message = FALSE, echo = FALSE}
g_DKA_IP_weekly_count_deprivation_vis
```
<br>
While inequalities in DKA admission are seen to exist between deprivation quintiles, they are lesser in Type 2 diabetes. In both cases, patients from the most deprived 20% of the population are responsible for the most DKA admissions.
<br>
<br>
<br>
Fig. 2.4.12
```{r DKA weekly count by deprivation - cum diff, warning = FALSE, message = FALSE, echo = FALSE}
e_DKA_cum_diff_deprivation_vis
```
<br>
The impact of the first lockdown was most disruptive to inpatient admissions for IMD quintiles 1 & 2. The rate a which admissions reduced during the second lockdown was also much higher for the more deprived groups.
<br>
<br>
<br>
Fig. 2.4.13
```{r DKA weekly count by deprivation - prop diff, warning = FALSE, message = FALSE, echo = FALSE}
e_DKA_prop_diff_deprivation_vis
```
<br>
While in absolute terms the more deprived groups saw greater reductions in DKA admissions, IMD quintile 5 experienced the largest proportional reduction however this is not statistically significant. 
<br>
<br>
<br>
Fig. 2.4.14
```{r DKA vs type 1 and 2 - deprivation, warning = FALSE, message = FALSE, echo = FALSE}
e_DKAvsType1_2_patch_deprivation
```
<br>
In the most affluent 20% of type 1 diabetics, we see a significantly less disrupted rate of ED attendances along with a more reduced rate of DKA admissions comparatively. Changes in demand appear to be in line with the above assumptions in tpye 2 diabetes.  
<br>
<br>
<br>

#### Ethnicity 

<br>
Fig. 2.4.15
```{r DKA weekly count by ethnicity, warning = FALSE, message = FALSE, echo = FALSE}
g_DKA_IP_weekly_count_ethnicity_vis /
  g_DKA_IP_weekly_count_ethnicity_nonWhite_vis
```
<br>
The seasonal nature of DKA admissions is most apparent in White groups and is consistent across diabetes types. Similarly, in both diabetes types, the rate of admissions in patients of "Unknown" ethnicity increases during the pandemic, perpahs suggesting compromised recording during times of high stress. 
<br>
<br>
<br>
Fig. 2.4.16
```{r DKA weekly count by ethnicity - cum diff, warning = FALSE, message = FALSE, echo = FALSE}
(
e_DKA_cum_diff_ethnicity %>%
  filter(demographic_var == "White") %>% 
  mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
  filter(demographic_var != "100+") %>% 
  ggplot(aes(week_number, count, colour = demographic_var)) +
  geom_hline(yintercept = 0, colour = "#636363") + 
  annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
  annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
  annotate("text", x = 20, y = -100, label = str_wrap("Lockdown", 10) ,size = 3) +
  annotate("text", x = 34, y = -100, label = str_wrap("Recovery", 10) ,size = 3) +
  annotate("text", x = 48, y = -100, label = str_wrap("Lockdown", 10) ,size = 3) +
  geom_smooth(method = 'loess', span = 0.3) +
  geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
  scale_color_manual(values = c("#5881c1")) +
  theme(legend.position = "none") +
  labs(title = "There was a sharp rise in DKA admissions in Black people during lockdown 1", 
       subtitle = "Cumulative change in weekly admission count for DKA between 2019 and 2020, by broad ethnicity",
       x = "",
       y = "Cumulative difference")
) /
  (
    # Excluding white group - Interesting
    e_DKA_cum_diff_ethnicity %>%
      filter(demographic_var != "White") %>% 
      mutate(label = if_else(week_number == max(week_number), as.character(demographic_var), NA_character_)) %>%
      filter(demographic_var != "100+") %>% 
      ggplot(aes(week_number, count, colour = demographic_var)) +
      geom_hline(yintercept = 0, colour = "#636363") + 
      annotate("segment", x = 13, xend = 13, y = -Inf, yend = Inf, lty = 2) +
      annotate("segment", x = 27, xend = 27, y = -Inf, yend = Inf, lty = 2) +
      annotate("segment", x = 42, xend = 42, y = -Inf, yend = Inf, lty = 2) +
      annotate("text", x = 20, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
      annotate("text", x = 34, y = 25, label = str_wrap("Recovery", 10) ,size = 3) +
      annotate("text", x = 48, y = 25, label = str_wrap("Lockdown", 10) ,size = 3) +
      geom_smooth(method = 'loess', span = 0.3) +
      geom_label_repel(aes(label = label), nudge_x = 1, size = 3.5,  na.rm = TRUE) +
      scale_color_SU(palette = "main") +
      theme(legend.position = "none") +
      labs( caption = "Admission difference = 2020 count - 2019 count",
            x = "Week Number",
            y = "Cumulative difference")
  )
```
<br>
As the magnitude of cumulative changes to DKA admission rates between ethinicities varies, so to does the direction; White groups saw reductions in rates limited to lockdown periods, while Black ethnicities experienced increased DKA incidence during lockdown periods with plateaus during the recovery period.
<br>
<br>
<br>
Fig. 2.4.17
```{r DKA weekly count by ethnicity - prop diff, warning = FALSE, message = FALSE, echo = FALSE}
e_DKA_prop_diff_ethnicity_vis
```
<br>
All three sub-groups of the Black ethnicity were seen to demonstrate increased DKA admissions during the pandemic, with members of the Caribbean community admitted at a rate 25% higher than the previous year.
<br>
<br>
<br>
Fig. 2.4.18
```{r DKA vs type 1 and 2 - ethnicity, warning = FALSE, message = FALSE, echo = FALSE}
e_DKAvsType1_2_patch_ethnicity
```
<br>
In type 1 and type 2 diabetics, patients from Pakistani and Caribbean ethnic groups appear to be presenting to ED less regularly than would be expected for said groups but were experiencing much higher rates of DKA admissions (approx 10% and 30% increased respectively).
<br>
<br>
<br>

## Attendances by severity 

<br>
Fig. 3.1
``` {r attendances by severity, warning = FALSE, message = FALSE, echo = FALSE}
g_diabetes_demographic_index %>% 
  mutate(Attendance_week = floor_date(Arrival_Date, unit = "week")) %>% 
  group_by(Attendance_week, Severity) %>% 
  summarise(n_attendances = sum(Admission_count)) %>%  #sum monthly attendances %>% 
  filter(Severity != "NA") %>% 
  
  ggplot(aes(x = Attendance_week, y = n_attendances, colour = Severity)) + 
  annotate("rect", xmin = as.Date("2020-03-23"), xmax = as.Date("2020-07-04"), ymin = 0, ymax = Inf, 
           fill= "#fed976", alpha = 0.6) + # Lockdown 1
  annotate("rect", xmin = as.Date("2020-10-14"), xmax = as.Date("2021-01-04"), ymin = 0, ymax = Inf, 
           fill= "#fed976", alpha = 0.6) + # 3 tier system
  annotate("text", x = as.Date("2020-05-13"), y = 800, label = "National lockdown",size = 3, angle = 90) +
  annotate("text", x = as.Date("2020-11-24"), y = 800, label = "3 Tier lockdown",size = 3, angle = 90) +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU(palette = "main") +
  labs(x = "Week", 
       y = "Attenances",
       title = "Emergency department attendences for diabetes by attendance severity",
       subtitle = "National, 2018-20")
```
<br>
By considering the duration of a patient's ED atttendance and whether or not that attendance resulted in an inpatient admission, we can deduce a measure of attendance severity. We can see that the pandemic impacted the rate of attendances that were treated in the ED and discharged without inpatient admission different than other severity flags; at the peak of the first national lockdown, ED's were more frequently treating patients and discharging from ED in under 4 hours, presumably to avoid further inpatient capacity stress and reduce covid risk to patients. 
<br>
<br>
<br>

### Type 1 Diabetes

Fig. 3.2.1
``` {r attendances by severity - type 1 diabetes, warning = FALSE, message = FALSE, echo = FALSE}
g_type1_weekly_count_severity_vis
```
<br>
Fig 3.2.2
``` {r attendances by severity - type 1 diabetes - prop diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type1_prop_diff_severity_vis
```
<br>
The first lockdown had similar impacts on the severity of type 1 diabetes attendances however the rate of return to pre-pandemic levels is lower in ED attendances that last between 4 and 12 hours and result in discharge from ED. 
<br>
<br>
<br>

### Type 2 Diabetes

Fig. 3.3.1
``` {r attendances by severity - type 2 diabetes, warning = FALSE, message = FALSE, echo = FALSE}
g_type2_weekly_count_severity_vis
```
<br>
Fig. 3.3.2
``` {r attendances by severity - type 2 diabetes - cum diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type2_cum_diff_severity_vis
```
<br>
Fig. 3.3.3
``` {r attendances by severity - type 2 diabetes - prop diff, warning = FALSE, message = FALSE, echo = FALSE}
e_type2_prop_diff_severity_vis
```
<br>
The first national lockdown saw a large increase in the rate of type 2 diabetic ED attendances being treated in ED in under 4 hours and discharged without requiring inpatient admission. This is a clear example of organisational behaviour change in the face of the pandemic to avoid admissions where possible. 
<br>
<br>
<br>

### DKA 

<br>
Fig. 3.4.1
```{r LoS in DKA, warning = FALSE, message = FALSE, echo = FALSE}
g_ip_diabetes_diag_DKA_LoS_ts_vis
```
<br>
Length of stay is seen to generally be less frequent but of longer duration in DKA admissions for type 2 diabetics than for type 1 diabetics. One explanation may be that DKA in type 2 patients is more likely to occur in older individuals who are therefore more likely to have more significant comorbidities which would increase the wider care requirements. Interestingly the length of stay for type 2 diabetics with DKA was more impacted by the covid-19 pandemic as illustrated by reducing average LoS during the first lockdown; a time when hospitals were motivated to create capacity for incoming covid-19 patients, this trend isn't seen in type 1 diabetics with DKA.  
<br>
<br>
<br>
Fig. 3.4.2
```{r Critical care days in DKA, warning = FALSE, message = FALSE, echo = FALSE}
g_ip_diabetes_diag_DKA_LoS_ts_critical_care
```
<br>
In support of the above explanation, type 2 diabetics with DKA are seen to require critical care intervention more frequently than type 1 diabetics. Similarly, critical care usage in type 2 was more impacted or purposefully limited during the first lockdown. 
<br>
<br>
<br>

# Notes and references

Notes: 

COVID-19 lockdown dates: <https://www.instituteforgovernment.org.uk/sites/default/files/timeline-lockdown-web.pdf>

References:

[1] The Strategy Unit., 2021. Strategy Unit analysis published showing changes in use of emergency departments under lockdown. Available at: <https://www.strategyunitwm.nhs.uk/news/strategy-unit-analysis-published-showing-changes-use-emergency-departments-under-lockdown> (Accessed 16th March 2021)





